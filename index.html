<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCMarket - Minecraft Content Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-green-hover: #16a34a;
            --admin-red: #ef4444;
            --admin-red-hover: #dc2626;
            --yellow-token: #fbbf24;
            --bg-dark: #1a1a2e;
            --bg-darker: #16213e;
            --bg-darkest: #0f3460;
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 50%, var(--bg-darkest) 100%);
            min-height: 100vh;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .token-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #fbbf24; }
            to { box-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; }
        }

        .admin-glow {
            animation: adminGlow 2s ease-in-out infinite alternate;
        }

        @keyframes adminGlow {
            from { box-shadow: 0 0 5px #ef4444; }
            to { box-shadow: 0 0 20px #ef4444, 0 0 30px #dc2626; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .dropdown-enter {
            animation: dropdownEnter 0.2s ease-out;
        }

        @keyframes dropdownEnter {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bg-gray-750 {
            background-color: rgba(55, 65, 81, 0.5);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        ::selection {
            background: rgba(34, 197, 94, 0.3);
            color: #fff;
        }

        button, a {
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(34, 197, 94, 0.3);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="loadingScreen">
        <div class="spinner mb-4"></div>
        <p class="text-gray-400">Lade MCMarket...</p>
    </div>
    <div id="app"></div>

    <script>
        // ============ SUPABASE CONFIG ============
        const SUPABASE_URL = 'https://lrjyxbwwqenczqucdtgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxyanl4Ynd3cWVuY3pxdWNkdGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNDIzMTQsImV4cCI6MjA4MjYxODMxNH0.j_r0DuYk8HlX-uCxU1hxDCkGYKjBK2dKIIvEObHTefQ';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase Client erstellt');
        } catch (e) {
            console.error('Supabase Init Fehler:', e);
        }
        
        // Admin E-Mail
        const ADMIN_EMAIL = 'mcmarket.2026@gmail.com';

        // ============ GLOBAL STATE ============
        let currentUserData = null;
        let cachedSettings = null;
        let cachedContent = [];
        let cachedUsers = [];
        let currentView = 'login';
        let selectedContent = null;
        let filterState = { category: 'all', priceType: 'all', mcVersion: 'all', search: '' };
        let adminTab = 'overview';
        let uploadedImagePreview = null;

        // ============ DEFAULT SETTINGS ============
        const defaultSettings = {
            tokenInterval: 'daily',
            tokenAmount: 10,
            uploadsEnabled: true,
            salesEnabled: true,
            tokenSystemEnabled: true,
            requireApproval: true,
            registrationEnabled: true,
            maintenanceMode: false,
            welcomeTokens: 50
        };

        // ============ DATABASE ============
        const DB = {
            async init() {
                console.log('DB.init() gestartet...');
                try {
                    // Settings laden
                    const { data: settings, error: settingsError } = await supabase
                        .from('settings')
                        .select('*')
                        .eq('id', 1)
                        .single();
                    
                    if (settings) {
                        cachedSettings = settings;
                        console.log('Settings geladen:', settings);
                    } else {
                        cachedSettings = defaultSettings;
                        console.log('Default Settings verwendet');
                    }

                    // Session pr√ºfen
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    console.log('Session:', session);
                    
                    if (session && session.user) {
                        const { data: profile, error: profileError } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            console.log('Profil geladen:', profile);
                        } else {
                            console.log('Kein Profil gefunden');
                        }
                    }
                    
                    return true;
                } catch (e) {
                    console.error('DB.init() Fehler:', e);
                    cachedSettings = defaultSettings;
                    return false;
                }
            },
            
            async getContent() { 
                try {
                    const { data, error } = await supabase
                        .from('content')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('getContent Fehler:', error);
                        return [];
                    }
                    
                    return (data || []).map(c => ({
                        ...c,
                        uploaderId: c.uploader_id,
                        uploaderName: c.uploader_name,
                        mcVersions: c.mc_versions || [],
                        fileName: c.file_name,
                        fileSize: c.file_size,
                        createdAt: c.created_at
                    }));
                } catch (e) {
                    console.error('getContent Exception:', e);
                    return [];
                }
            },
            
            async getUsers() { 
                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*');
                    return data || [];
                } catch (e) {
                    console.error('getUsers Fehler:', e);
                    return [];
                }
            },
            
            async getPurchases() { 
                if (!currentUserData) return [];
                try {
                    const { data } = await supabase
                        .from('purchases')
                        .select('*')
                        .eq('user_id', currentUserData.id);
                    
                    return (data || []).map(p => ({
                        ...p,
                        contentId: p.content_id,
                        userId: p.user_id,
                        date: p.created_at
                    }));
                } catch (e) {
                    console.error('getPurchases Fehler:', e);
                    return [];
                }
            },
            
            async getTransactions() { 
                if (!currentUserData) return [];
                try {
                    const { data } = await supabase
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUserData.id)
                        .order('created_at', { ascending: false });
                    
                    return (data || []).map(t => ({
                        ...t,
                        userId: t.user_id,
                        date: t.created_at
                    }));
                } catch (e) {
                    console.error('getTransactions Fehler:', e);
                    return [];
                }
            },
            
            getSettings() { 
                return cachedSettings || defaultSettings;
            },

            getCurrentUser() { 
                return currentUserData;
            },

            isAdmin(user) {
                return user && (user.role === 'admin' || user.email === ADMIN_EMAIL);
            },

            getImage(contentId) {
                try {
                    const images = JSON.parse(localStorage.getItem('mcmarket_images') || '{}');
                    return images[contentId] || null;
                } catch (e) {
                    return null;
                }
            },

            saveImage(contentId, imageData) {
                try {
                    const images = JSON.parse(localStorage.getItem('mcmarket_images') || '{}');
                    images[contentId] = imageData;
                    localStorage.setItem('mcmarket_images', JSON.stringify(images));
                } catch (e) {
                    console.error('saveImage Fehler:', e);
                }
            },

            getFile(contentId) {
                try {
                    const files = JSON.parse(localStorage.getItem('mcmarket_files') || '{}');
                    return files[contentId] || null;
                } catch (e) {
                    return null;
                }
            },

            saveFile(contentId, fileData) {
                try {
                    const files = JSON.parse(localStorage.getItem('mcmarket_files') || '{}');
                    files[contentId] = fileData;
                    localStorage.setItem('mcmarket_files', JSON.stringify(files));
                } catch (e) {
                    console.error('saveFile Fehler:', e);
                }
            }
        };

        // ============ UTILITY FUNCTIONS ============
        const Utils = {
            generateId: () => 'id_' + Math.random().toString(36).substr(2, 9),
            formatDate: (dateStr) => {
                try {
                    return new Date(dateStr).toLocaleDateString('de-DE');
                } catch (e) {
                    return 'N/A';
                }
            },
            
            formatTokens(tokens) {
                if (tokens === Infinity || tokens === 'Infinity' || !isFinite(tokens)) return '‚àû';
                return (tokens || 0).toLocaleString('de-DE');
            },

            showToast(message, type = 'success') {
                const existing = document.querySelectorAll('.toast-msg');
                existing.forEach(el => el.remove());
                
                const toast = document.createElement('div');
                toast.className = `toast-msg fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 fade-in ${
                    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            getCategoryIcon(cat) {
                const icons = { plugin: 'fa-puzzle-piece', mod: 'fa-cube', texturepack: 'fa-image', world: 'fa-globe' };
                return icons[cat] || 'fa-file';
            },

            getCategoryName(cat) {
                const names = { plugin: 'Plugin', mod: 'Mod', texturepack: 'Texturepack', world: 'Welt' };
                return names[cat] || cat;
            },

            canClaimTokens(user) {
                if (!user || DB.isAdmin(user)) return false;
                const settings = DB.getSettings();
                if (!settings.tokenSystemEnabled) return false;
                if (!user.last_token_claim) return true;
                const last = new Date(user.last_token_claim);
                const now = new Date();
                const diff = now - last;
                const intervals = { hourly: 3600000, daily: 86400000, weekly: 604800000, monthly: 2592000000 };
                return diff >= intervals[settings.tokenInterval];
            },

            getTimeUntilNextClaim(user) {
                if (!user || DB.isAdmin(user)) return 'Unbegrenzt';
                const settings = DB.getSettings();
                if (!user.last_token_claim) return 'Jetzt verf√ºgbar!';
                const last = new Date(user.last_token_claim);
                const now = new Date();
                const intervals = { hourly: 3600000, daily: 86400000, weekly: 604800000, monthly: 2592000000 };
                const nextClaim = new Date(last.getTime() + intervals[settings.tokenInterval]);
                const diff = nextClaim - now;
                if (diff <= 0) return 'Jetzt verf√ºgbar!';
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                if (hours > 24) return `${Math.floor(hours / 24)} Tag(e) ${hours % 24}h`;
                return `${hours}h ${minutes}m`;
            },
            
            formatFileSize(bytes) {
                if (!bytes) return 'N/A';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(2) + ' MB';
            }
        };

        // ============ AUTH FUNCTIONS ============
        const Auth = {
            async login(email, password) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) {
                        console.error('Login error:', error);
                        return null;
                    }
                    
                    if (data.user) {
                        const { data: profile } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', data.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            return profile;
                        }
                    }
                    return null;
                } catch (e) {
                    console.error('Login exception:', e);
                    return null;
                }
            },

            async register(username, email, password) {
                try {
                    const settings = DB.getSettings();
                    if (!settings.registrationEnabled) return { error: 'Registrierung deaktiviert' };
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                username: username
                            }
                        }
                    });
                    
                    if (error) {
                        console.error('Register error:', error);
                        return { error: error.message };
                    }
                    
                    if (data.user) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        const { data: profile } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', data.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            return { success: true, user: profile };
                        }
                    }
                    
                    return { success: true, user: data.user };
                } catch (e) {
                    console.error('Register exception:', e);
                    return { error: e.message };
                }
            },

            async logout() {
                await supabase.auth.signOut();
                currentUserData = null;
            },

            async claimTokens() {
                const user = DB.getCurrentUser();
                if (!user || DB.isAdmin(user)) return false;
                if (!Utils.canClaimTokens(user)) return false;

                const settings = DB.getSettings();
                const newTokens = (user.tokens || 0) + settings.tokenAmount;
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        tokens: newTokens,
                        last_token_claim: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (!error) {
                    currentUserData.tokens = newTokens;
                    currentUserData.last_token_claim = new Date().toISOString();
                    
                    await supabase.from('transactions').insert({
                        user_id: user.id,
                        type: 'earn',
                        amount: settings.tokenAmount,
                        description: `Token-Belohnung (${settings.tokenInterval})`
                    });
                    return true;
                }
                return false;
            }
        };

        // ============ CONTENT FUNCTIONS ============
        const Content = {
            async hasPurchased(contentId) {
                const user = DB.getCurrentUser();
                if (!user) return false;
                if (DB.isAdmin(user)) return true;
                const purchases = await DB.getPurchases();
                return purchases.some(p => p.contentId === contentId);
            },

            async purchase(contentId) {
                const user = DB.getCurrentUser();
                const allContent = await DB.getContent();
                const content = allContent.find(c => c.id === contentId);
                const settings = DB.getSettings();

                if (!user || !content) return false;
                
                if (DB.isAdmin(user)) return true;
                if (!settings.salesEnabled) return false;
                if ((user.tokens || 0) < content.price) return false;

                const purchases = await DB.getPurchases();
                if (purchases.find(p => p.contentId === contentId)) return 'already';

                // Tokens abziehen
                const newTokens = (user.tokens || 0) - content.price;
                await supabase.from('profiles').update({ tokens: newTokens }).eq('id', user.id);
                currentUserData.tokens = newTokens;

                // Kauf speichern
                await supabase.from('purchases').insert({
                    user_id: user.id,
                    content_id: contentId,
                    price: content.price
                });

                // Downloads erh√∂hen
                await supabase.from('content').update({ 
                    downloads: (content.downloads || 0) + 1 
                }).eq('id', contentId);

                // Transaktion speichern
                await supabase.from('transactions').insert({
                    user_id: user.id,
                    type: 'purchase',
                    amount: -content.price,
                    description: `Kauf: ${content.title}`
                });

                return true;
            }
        };

        // ============ RENDER FUNCTIONS ============
        const Render = {
            async app() {
                const user = DB.getCurrentUser();
                const app = document.getElementById('app');
                const settings = DB.getSettings();

                document.getElementById('loadingScreen').style.display = 'none';

                if (settings.maintenanceMode && (!user || !DB.isAdmin(user))) {
                    app.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-tools text-6xl text-yellow-500 mb-4"></i>
                                <h1 class="text-3xl font-bold mb-2">Wartungsmodus</h1>
                                <p class="text-gray-400">Die Seite ist vor√ºbergehend nicht verf√ºgbar.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (!user) {
                    this.authPage();
                    return;
                }

                app.innerHTML = `
                    ${this.navbar()}
                    <main class="container mx-auto px-4 py-6 min-h-screen">
                        <div id="content"></div>
                    </main>
                    ${this.footer()}
                `;
                await this.navigate(currentView);
            },

            navbar() {
                const user = DB.getCurrentUser();
                const settings = DB.getSettings();
                const isAdmin = DB.isAdmin(user);
                const canClaim = !isAdmin && Utils.canClaimTokens(user);

                return `
                    <nav class="bg-gray-900/80 backdrop-blur-sm border-b ${isAdmin ? 'border-red-500/50' : 'border-gray-700'} sticky top-0 z-40">
                        <div class="container mx-auto px-4">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center space-x-8">
                                    <div class="flex items-center space-x-2 cursor-pointer" onclick="Render.navigate('marketplace')">
                                        <i class="fas fa-cube text-2xl text-green-500"></i>
                                        <span class="text-xl font-bold">MCMarket</span>
                                        ${isAdmin ? '<span class="text-xs bg-red-500 px-2 py-0.5 rounded">ADMIN</span>' : ''}
                                    </div>
                                    <div class="hidden md:flex space-x-4">
                                        <button onclick="Render.navigate('marketplace')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-store mr-2"></i>Marktplatz
                                        </button>
                                        <button onclick="Render.navigate('purchases')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-shopping-bag mr-2"></i>Meine K√§ufe
                                        </button>
                                        <button onclick="Render.navigate('upload')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-upload mr-2"></i>Hochladen
                                        </button>
                                        ${isAdmin ? `<button onclick="Render.navigate('admin')" class="px-3 py-2 rounded-lg hover:bg-red-600/30 transition text-red-400 bg-red-500/20 border border-red-500/50"><i class="fas fa-crown mr-2"></i>Admin Panel</button>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    ${settings.tokenSystemEnabled ? `
                                        <div class="flex items-center space-x-2">
                                            ${isAdmin ? `
                                                <div class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-red-500/20 border border-red-500 admin-glow">
                                                    <i class="fas fa-infinity text-red-400"></i>
                                                    <span class="font-bold text-red-400">UNBEGRENZT</span>
                                                </div>
                                            ` : `
                                                <button onclick="handleClaimTokens()" class="flex items-center space-x-2 px-4 py-2 rounded-lg ${canClaim ? 'bg-yellow-500/20 border border-yellow-500 token-glow cursor-pointer hover:bg-yellow-500/30' : 'bg-gray-700'} transition">
                                                    <i class="fas fa-coins text-yellow-400"></i>
                                                    <span class="font-bold text-yellow-400">${Utils.formatTokens(user.tokens)}</span>
                                                    ${canClaim ? '<i class="fas fa-gift text-green-400 ml-2"></i>' : ''}
                                                </button>
                                                ${!canClaim ? `<span class="text-xs text-gray-400">${Utils.getTimeUntilNextClaim(user)}</span>` : ''}
                                            `}
                                        </div>
                                    ` : ''}
                                    <div class="relative" id="profileDropdown">
                                        <button onclick="toggleProfileDropdown()" class="flex items-center space-x-2 px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <div class="w-8 h-8 rounded-full ${isAdmin ? 'bg-gradient-to-br from-red-400 to-yellow-500' : 'bg-gradient-to-br from-green-400 to-blue-500'} flex items-center justify-center">
                                                ${isAdmin ? '<i class="fas fa-crown text-sm"></i>' : (user.username || 'U').charAt(0).toUpperCase()}
                                            </div>
                                            <span class="hidden md:block">${user.username || 'User'}</span>
                                            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                                        </button>
                                        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50 overflow-hidden dropdown-enter">
                                            <div class="px-4 py-3 border-b border-gray-700 bg-gray-750">
                                                <p class="font-bold">${user.username || 'User'}</p>
                                                <p class="text-sm text-gray-400">${user.email}</p>
                                                <span class="text-xs px-2 py-0.5 rounded ${isAdmin ? 'bg-red-500' : user.role === 'creator' ? 'bg-purple-500' : 'bg-blue-500'}">${user.role || 'user'}</span>
                                            </div>
                                            <div class="py-1">
                                                <button onclick="Render.navigate('profile'); closeProfileDropdown();" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                                                    <i class="fas fa-user mr-3 text-blue-400"></i>Mein Profil
                                                </button>
                                                <button onclick="Render.navigate('settings'); closeProfileDropdown();" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                                                    <i class="fas fa-cog mr-3 text-gray-400"></i>Einstellungen
                                                </button>
                                            </div>
                                            <div class="border-t border-gray-700 py-1">
                                                <button onclick="handleLogout()" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center text-red-400">
                                                    <i class="fas fa-sign-out-alt mr-3"></i>Abmelden
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
            },

            authPage() {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-8 w-full max-w-md border border-gray-700 fade-in">
                            <div class="text-center mb-8">
                                <i class="fas fa-cube text-5xl text-green-500 mb-4"></i>
                                <h1 class="text-3xl font-bold">MCMarket</h1>
                                <p class="text-gray-400 mt-2">Minecraft Content Marketplace</p>
                            </div>
                            
                            <div class="flex mb-6 bg-gray-700/50 rounded-lg p-1">
                                <button id="loginTab" onclick="switchAuthTab('login')" class="flex-1 py-2 rounded-lg bg-green-600 transition">Login</button>
                                <button id="registerTab" onclick="switchAuthTab('register')" class="flex-1 py-2 rounded-lg transition">Registrieren</button>
                            </div>

                            <form id="loginForm" onsubmit="handleLogin(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">E-Mail</label>
                                        <input type="email" id="loginEmail" required class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="deine@email.de">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Passwort</label>
                                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold transition">
                                        <i class="fas fa-sign-in-alt mr-2"></i>Anmelden
                                    </button>
                                </div>
                            </form>

                            <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Benutzername</label>
                                        <input type="text" id="regUsername" required class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Dein Username">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">E-Mail</label>
                                        <input type="email" id="regEmail" required class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="deine@email.de">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Passwort</label>
                                        <input type="password" id="regPassword" required minlength="8" class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Min. 8 Zeichen">
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <input type="checkbox" id="agbCheckbox" required class="mt-1 w-4 h-4 accent-green-500">
                                        <label for="agbCheckbox" class="text-sm text-gray-400">
                                            Ich akzeptiere die <a href="#" onclick="Legal.showAGB(); return false;" class="text-green-400 hover:underline">AGB</a> und 
                                            <a href="#" onclick="Legal.showDatenschutz(); return false;" class="text-green-400 hover:underline">Datenschutzerkl√§rung</a>
                                        </label>
                                    </div>
                                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold transition">
                                        <i class="fas fa-user-plus mr-2"></i>Registrieren
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            async navigate(view) {
                currentView = view;
                const content = document.getElementById('content');
                if (!content) return;

                content.innerHTML = '<div class="flex justify-center py-16"><div class="spinner"></div></div>';

                switch(view) {
                    case 'marketplace': await this.marketplace(); break;
                    case 'purchases': await this.purchases(); break;
                    case 'upload': this.upload(); break;
                    case 'admin': await this.admin(); break;
                    case 'profile': await this.profile(); break;
                    case 'settings': this.userSettings(); break;
                    case 'content-detail': await this.contentDetail(); break;
                    default: await this.marketplace();
                }
            },

            async marketplace() {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const allContent = await DB.getContent();
                const content = isAdmin ? allContent : allContent.filter(c => c.approved && c.visibility === 'public');

                const filteredContent = this.filterContent(content);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <div>
                                <h1 class="text-3xl font-bold"><i class="fas fa-store mr-3 text-green-500"></i>Marktplatz</h1>
                                <p class="text-gray-400 mt-1">${content.length} Inhalte verf√ºgbar</p>
                            </div>
                            <input type="text" id="searchInput" placeholder="Suchen..." class="px-4 py-2 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" value="${filterState.search}" oninput="updateFilter('search', this.value)">
                        </div>

                        <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-800/30 rounded-xl border border-gray-700/50">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Kategorie</label>
                                <select onchange="updateFilter('category', this.value)" class="px-3 py-2 bg-gray-700/50 rounded-lg border border-gray-600 text-sm">
                                    <option value="all" ${filterState.category === 'all' ? 'selected' : ''}>üéÆ Alle Kategorien</option>
                                    <option value="plugin" ${filterState.category === 'plugin' ? 'selected' : ''}>üß© Plugins</option>
                                    <option value="mod" ${filterState.category === 'mod' ? 'selected' : ''}>üì¶ Mods</option>
                                    <option value="texturepack" ${filterState.category === 'texturepack' ? 'selected' : ''}>üé® Texturepacks</option>
                                    <option value="world" ${filterState.category === 'world' ? 'selected' : ''}>üåç Welten</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Preis</label>
                                <select onchange="updateFilter('priceType', this.value)" class="px-3 py-2 bg-gray-700/50 rounded-lg border border-gray-600 text-sm">
                                    <option value="all" ${filterState.priceType === 'all' ? 'selected' : ''}>üí∞ Alle Preise</option>
                                    <option value="free" ${filterState.priceType === 'free' ? 'selected' : ''}>üÜì Kostenlos</option>
                                    <option value="paid" ${filterState.priceType === 'paid' ? 'selected' : ''}>üíé Kostenpflichtig</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="filterState = { category: 'all', priceType: 'all', mcVersion: 'all', search: '' }; Render.marketplace();" class="px-3 py-2 bg-gray-700/30 hover:bg-gray-700 rounded-lg text-sm text-gray-400 hover:text-white transition">
                                    <i class="fas fa-times mr-1"></i>Reset
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filteredContent.map(item => this.contentCard(item)).join('')}
                        </div>

                        ${filteredContent.length === 0 ? `
                            <div class="text-center py-16 bg-gray-800/30 rounded-xl border border-gray-700/50">
                                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-700/50 flex items-center justify-center">
                                    <i class="fas fa-box-open text-4xl text-gray-600"></i>
                                </div>
                                <p class="text-xl font-bold mb-2">Keine Inhalte gefunden</p>
                                <p class="text-gray-500 mb-6">Versuche andere Filter oder lade selbst etwas hoch!</p>
                                <button onclick="Render.navigate('upload')" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold transition">
                                    <i class="fas fa-upload mr-2"></i>Jetzt hochladen
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            filterContent(content) {
                return content.filter(item => {
                    if (filterState.category !== 'all' && item.category !== filterState.category) return false;
                    if (filterState.priceType === 'free' && item.price > 0) return false;
                    if (filterState.priceType === 'paid' && item.price === 0) return false;
                    if (filterState.search && !item.title.toLowerCase().includes(filterState.search.toLowerCase())) return false;
                    return true;
                });
            },

            contentCard(item) {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const canAfford = isAdmin || (user.tokens || 0) >= item.price;
                const image = DB.getImage(item.id);
                const categoryColors = {
                    plugin: 'from-green-600 to-emerald-800',
                    mod: 'from-blue-600 to-indigo-800',
                    texturepack: 'from-purple-600 to-pink-800',
                    world: 'from-cyan-600 to-teal-800'
                };

                return `
                    <div class="bg-gray-800/50 rounded-xl overflow-hidden card-hover border ${!item.approved ? 'border-yellow-500' : 'border-gray-700'} cursor-pointer" onclick="viewContent('${item.id}')">
                        <div class="h-40 bg-gradient-to-br ${image ? '' : categoryColors[item.category] || 'from-gray-700 to-gray-800'} flex items-center justify-center relative overflow-hidden">
                            ${image ? `<img src="${image}" class="w-full h-full object-cover" alt="${item.title}">` : `
                                <div class="text-center">
                                    <i class="fas ${Utils.getCategoryIcon(item.category)} text-5xl text-white/30 mb-2"></i>
                                </div>
                            `}
                            <div class="absolute top-3 left-3 flex items-center space-x-1 px-2 py-1 text-xs rounded-lg bg-black/50 backdrop-blur-sm">
                                <i class="fas ${Utils.getCategoryIcon(item.category)} text-xs"></i>
                                <span>${Utils.getCategoryName(item.category)}</span>
                            </div>
                            ${!item.approved ? `<span class="absolute top-3 right-3 px-2 py-1 text-xs rounded-lg bg-yellow-500/90"><i class="fas fa-clock mr-1"></i>Ausstehend</span>` :
                              item.price === 0 ? `<span class="absolute top-3 right-3 px-2 py-1 text-xs rounded-lg bg-green-500/90 font-bold">GRATIS</span>` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1 truncate">${item.title}</h3>
                            <p class="text-gray-500 text-xs mb-3">von ${item.uploaderName || 'Unbekannt'}</p>
                            <p class="text-gray-400 text-sm mb-3 line-clamp-2">${(item.description || '').substring(0, 60)}...</p>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <span class="flex items-center"><i class="fas fa-download mr-1"></i>${item.downloads || 0}</span>
                                    ${item.mcVersions && item.mcVersions.length > 0 ? `<span class="flex items-center"><i class="fas fa-gamepad mr-1"></i>${item.mcVersions[0]}</span>` : ''}
                                </div>
                                <div class="flex items-center space-x-1 font-bold text-sm ${item.price === 0 || isAdmin ? 'text-green-400' : canAfford ? 'text-yellow-400' : 'text-red-400'}">
                                    ${isAdmin ? '<i class="fas fa-infinity text-xs"></i>' : item.price === 0 ? '<i class="fas fa-gift"></i>' : `<i class="fas fa-coins text-xs"></i> ${item.price}`}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            async contentDetail() {
                const allContent = await DB.getContent();
                const item = allContent.find(c => c.id === selectedContent);
                if (!item) { await this.navigate('marketplace'); return; }

                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const purchased = await Content.hasPurchased(item.id);
                const canAfford = isAdmin || (user.tokens || 0) >= item.price;
                const isOwner = item.uploaderId === user.id;
                const image = DB.getImage(item.id);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto">
                        <button onclick="Render.navigate('marketplace')" class="mb-6 text-gray-400 hover:text-white transition">
                            <i class="fas fa-arrow-left mr-2"></i>Zur√ºck zum Marktplatz
                        </button>

                        <div class="bg-gray-800/50 rounded-2xl overflow-hidden border border-gray-700">
                            <div class="h-64 bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center relative overflow-hidden">
                                ${image ? `<img src="${image}" class="w-full h-full object-cover" alt="${item.title}">` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-8xl text-gray-600"></i>`}
                                <span class="absolute top-4 left-4 px-3 py-1 rounded-full bg-gray-900/80 text-sm">${Utils.getCategoryName(item.category)}</span>
                            </div>

                            <div class="p-8">
                                <div class="flex flex-col md:flex-row justify-between gap-6 mb-8">
                                    <div class="flex-1">
                                        <h1 class="text-3xl font-bold mb-2">${item.title}</h1>
                                        <p class="text-gray-400 mb-4">von <span class="text-green-400">${item.uploaderName || 'Unbekannt'}</span> ‚Ä¢ ${Utils.formatDate(item.createdAt)}</p>
                                        <div class="flex items-center gap-4 text-sm text-gray-400">
                                            <span><i class="fas fa-download mr-1"></i>${item.downloads || 0} Downloads</span>
                                            <span><i class="fas fa-file mr-1"></i>${item.fileSize || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-3">
                                        <div class="text-3xl font-bold ${item.price === 0 || isAdmin ? 'text-green-400' : 'text-yellow-400'}">
                                            ${isAdmin ? '<i class="fas fa-infinity"></i> Kostenlos' : item.price === 0 ? 'Kostenlos' : `<i class="fas fa-coins"></i> ${item.price}`}
                                        </div>
                                        ${purchased || isOwner || item.price === 0 || isAdmin ? `
                                            <button onclick="handleDownload('${item.id}')" class="px-8 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold transition flex items-center justify-center">
                                                <i class="fas fa-download mr-2"></i>Herunterladen
                                            </button>
                                        ` : canAfford ? `
                                            <button onclick="handlePurchase('${item.id}')" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold transition flex items-center">
                                                <i class="fas fa-shopping-cart mr-2"></i>Kaufen f√ºr ${item.price} Tokens
                                            </button>
                                        ` : `
                                            <button disabled class="px-8 py-3 bg-gray-600 rounded-lg font-bold cursor-not-allowed flex items-center">
                                                <i class="fas fa-lock mr-2"></i>Nicht genug Tokens
                                            </button>
                                            <p class="text-red-400 text-sm">Du brauchst noch ${item.price - (user.tokens || 0)} Tokens</p>
                                        `}
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h2 class="text-xl font-bold mb-3">Beschreibung</h2>
                                    <p class="text-gray-300 leading-relaxed whitespace-pre-wrap">${item.description || 'Keine Beschreibung'}</p>
                                </div>

                                ${item.mcVersions && item.mcVersions.length > 0 ? `
                                    <div class="mb-8">
                                        <h2 class="text-xl font-bold mb-3">Unterst√ºtzte Versionen</h2>
                                        <div class="flex flex-wrap gap-2">
                                            ${item.mcVersions.map(v => `<span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full">${v}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="bg-gray-700/30 rounded-lg p-4">
                                    <h3 class="font-bold mb-2">Dateidetails</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div><span class="text-gray-400">Dateiname</span><p>${item.fileName || 'N/A'}</p></div>
                                        <div><span class="text-gray-400">Gr√∂√üe</span><p>${item.fileSize || 'N/A'}</p></div>
                                        <div><span class="text-gray-400">Kategorie</span><p>${Utils.getCategoryName(item.category)}</p></div>
                                        <div><span class="text-gray-400">Hochgeladen</span><p>${Utils.formatDate(item.createdAt)}</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            async purchases() {
                const user = DB.getCurrentUser();
                const purchases = await DB.getPurchases();
                const allContent = await DB.getContent();
                const categoryColors = {
                    plugin: 'from-green-600 to-emerald-800',
                    mod: 'from-blue-600 to-indigo-800',
                    texturepack: 'from-purple-600 to-pink-800',
                    world: 'from-cyan-600 to-teal-800'
                };

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-shopping-bag mr-3 text-green-500"></i>Meine K√§ufe</h1>
                        
                        ${purchases.length === 0 ? `
                            <div class="text-center py-16 bg-gray-800/30 rounded-xl border border-gray-700/50">
                                <i class="fas fa-shopping-cart text-6xl text-gray-700 mb-4"></i>
                                <p class="text-xl text-gray-400 mb-2">Noch keine K√§ufe</p>
                                <p class="text-gray-500 mb-6">Entdecke tolle Inhalte im Marktplatz!</p>
                                <button onclick="Render.navigate('marketplace')" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition font-bold">
                                    <i class="fas fa-store mr-2"></i>Zum Marktplatz
                                </button>
                            </div>
                        ` : `
                            <div class="grid gap-4">
                                ${purchases.map(p => {
                                    const item = allContent.find(c => c.id === p.contentId);
                                    if (!item) return '';
                                    const image = DB.getImage(item.id);
                                    return `
                                        <div class="bg-gray-800/30 rounded-xl p-4 flex items-center justify-between border border-gray-700/50 hover:border-gray-600 transition group">
                                            <div class="flex items-center space-x-4">
                                                <div class="w-16 h-16 bg-gradient-to-br ${categoryColors[item.category] || 'from-gray-700 to-gray-800'} rounded-lg flex items-center justify-center overflow-hidden">
                                                    ${image ? `<img src="${image}" class="w-full h-full object-cover" alt="${item.title}">` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-2xl text-white/50"></i>`}
                                                </div>
                                                <div>
                                                    <h3 class="font-bold group-hover:text-green-400 transition">${item.title}</h3>
                                                    <p class="text-sm text-gray-500">${Utils.getCategoryName(item.category)} ‚Ä¢ ${Utils.formatDate(p.date)}</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-4">
                                                <span class="text-yellow-400 text-sm"><i class="fas fa-coins mr-1"></i>${p.price}</span>
                                                <button onclick="handleDownload('${item.id}')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition flex items-center">
                                                    <i class="fas fa-download mr-2"></i>Download
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            upload() {
                const user = DB.getCurrentUser();
                const settings = DB.getSettings();

                if (!settings.uploadsEnabled && !DB.isAdmin(user)) {
                    document.getElementById('content').innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                            <p class="text-xl">Uploads sind derzeit deaktiviert</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-2xl mx-auto">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-upload mr-3 text-green-500"></i>Inhalt Hochladen</h1>
                        
                        <form onsubmit="handleUpload(event)" class="bg-gray-800/50 rounded-xl p-6 border border-gray-700 space-y-6">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Titel *</label>
                                <input type="text" id="uploadTitle" required class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="z.B. Super Plugin Pro">
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Beschreibung *</label>
                                <textarea id="uploadDesc" required rows="4" class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Beschreibe deinen Inhalt..."></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Kategorie *</label>
                                    <select id="uploadCategory" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                        <option value="plugin">üß© Plugin</option>
                                        <option value="mod">üì¶ Mod</option>
                                        <option value="texturepack">üé® Texturepack</option>
                                        <option value="world">üåç Welt</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Preis (Tokens)</label>
                                    <input type="number" id="uploadPrice" min="0" value="0" class="w-full px-4 py-3 bg-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Minecraft Versionen</label>
                                <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-gray-700/50 rounded-lg">
                                    ${['1.21', '1.20.4', '1.20.2', '1.20.1', '1.19.4', '1.19.2', '1.18.2', '1.17.1', '1.16.5', '1.12.2', '1.8.9'].map(v => `
                                        <label class="flex items-center space-x-2 px-3 py-2 bg-gray-600 rounded-lg cursor-pointer hover:bg-gray-500 transition">
                                            <input type="checkbox" name="mcVersion" value="${v}" class="accent-green-500">
                                            <span>${v}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Vorschaubild (optional)</label>
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('imageInput').click()">
                                    <div id="imagePreview" class="hidden mb-4">
                                        <img id="previewImg" class="max-h-48 mx-auto rounded-lg" alt="Vorschau">
                                    </div>
                                    <i class="fas fa-image text-3xl text-gray-500 mb-2"></i>
                                    <p class="text-gray-400">Bild hochladen (PNG, JPG)</p>
                                    <input type="file" id="imageInput" class="hidden" accept="image/png,image/jpeg,image/gif" onchange="handleImagePreview(event)">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Datei hochladen *</label>
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-green-500 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-500 mb-2"></i>
                                    <p class="text-gray-400">Klicke zum Hochladen</p>
                                    <p class="text-sm text-gray-500 mt-1">.jar, .zip, .sk, .yml, .json erlaubt (max. 5MB)</p>
                                    <input type="file" id="fileInput" class="hidden" accept=".jar,.zip,.sk,.yml,.json,.png,.mcpack,.mcworld" required>
                                </div>
                                <p id="fileName" class="mt-2 text-green-400"></p>
                            </div>

                            <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold transition">
                                <i class="fas fa-upload mr-2"></i>Hochladen
                            </button>
                        </form>
                    </div>
                `;

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        document.getElementById('fileName').textContent = '‚úì ' + e.target.files[0].name + ' (' + Utils.formatFileSize(e.target.files[0].size) + ')';
                    }
                });
            },

            userSettings() {
                const user = DB.getCurrentUser();

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-2xl mx-auto">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-cog mr-3 text-gray-400"></i>Einstellungen</h1>
                        
                        <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700 space-y-6">
                            <div>
                                <h2 class="text-xl font-bold mb-4"><i class="fas fa-user mr-2 text-blue-400"></i>Account</h2>
                                <div class="space-y-4">
                                    <div class="p-4 bg-gray-700/50 rounded-lg">
                                        <p class="text-gray-400 text-sm">E-Mail</p>
                                        <p class="font-bold">${user.email}</p>
                                    </div>
                                    <div class="p-4 bg-gray-700/50 rounded-lg">
                                        <p class="text-gray-400 text-sm">Benutzername</p>
                                        <p class="font-bold">${user.username || 'Nicht gesetzt'}</p>
                                    </div>
                                    <div class="p-4 bg-gray-700/50 rounded-lg">
                                        <p class="text-gray-400 text-sm">Rolle</p>
                                        <p class="font-bold">${user.role || 'user'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-gray-700 pt-6">
                                <h2 class="text-xl font-bold mb-4 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Gefahrenzone</h2>
                                <button onclick="handleLogout()" class="w-full p-4 bg-red-500/10 border border-red-500/50 rounded-lg hover:bg-red-500/20 transition text-left flex items-center justify-between text-red-400">
                                    <span><i class="fas fa-sign-out-alt mr-2"></i>Abmelden</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            async profile() {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const transactions = await DB.getTransactions();
                const purchases = await DB.getPurchases();
                const allContent = await DB.getContent();
                const userContent = allContent.filter(c => c.uploaderId === user.id);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-user mr-3 text-green-500"></i>Mein Profil</h1>

                        <div class="bg-gray-800/50 rounded-xl p-6 border ${isAdmin ? 'border-red-500' : 'border-gray-700'} mb-6">
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="w-20 h-20 rounded-full ${isAdmin ? 'bg-gradient-to-br from-red-400 to-yellow-500 admin-glow' : 'bg-gradient-to-br from-green-400 to-blue-500'} flex items-center justify-center text-3xl font-bold">
                                    ${isAdmin ? '<i class="fas fa-crown"></i>' : (user.username || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-2xl font-bold">${user.username || 'User'}</h2>
                                    <p class="text-gray-400">${user.email}</p>
                                    <span class="text-xs px-2 py-1 rounded ${isAdmin ? 'bg-red-500' : 'bg-blue-500'}">${(user.role || 'user').toUpperCase()}</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold ${isAdmin ? 'text-red-400' : 'text-yellow-400'}">${isAdmin ? '‚àû' : Utils.formatTokens(user.tokens)}</div>
                                    <div class="text-xs text-gray-400">Tokens</div>
                                </div>
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-400">${purchases.length}</div>
                                    <div class="text-xs text-gray-400">K√§ufe</div>
                                </div>
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-400">${userContent.length}</div>
                                    <div class="text-xs text-gray-400">Uploads</div>
                                </div>
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-400">${Utils.formatDate(user.created_at)}</div>
                                    <div class="text-xs text-gray-400">Mitglied seit</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold mb-4"><i class="fas fa-history mr-2 text-yellow-400"></i>Letzte Transaktionen</h3>
                            ${transactions.length === 0 ? `<p class="text-gray-400 text-center py-4">Keine Transaktionen</p>` : `
                                <div class="space-y-2">
                                    ${transactions.slice(0, 10).map(t => `
                                        <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                                            <div class="flex items-center">
                                                <i class="fas ${t.amount > 0 ? 'fa-arrow-down text-green-400' : 'fa-arrow-up text-red-400'} mr-3"></i>
                                                <span class="${t.amount > 0 ? 'text-green-400' : 'text-red-400'} font-bold">${t.amount > 0 ? '+' : ''}${t.amount}</span>
                                                <span class="text-gray-400 ml-2">${t.description || 'Transaktion'}</span>
                                            </div>
                                            <span class="text-sm text-gray-500">${Utils.formatDate(t.date)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            async admin() {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) {
                    document.getElementById('content').innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-shield-alt text-5xl text-red-500 mb-4"></i>
                            <p class="text-xl">Zugriff verweigert</p>
                        </div>
                    `;
                    return;
                }

                const users = await DB.getUsers();
                const content = await DB.getContent();
                const pendingContent = content.filter(c => !c.approved).length;

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <h1 class="text-3xl font-bold"><i class="fas fa-crown mr-3 text-red-500"></i>Admin Panel</h1>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-blue-400">${users.length}</div>
                                <div class="text-gray-400">Benutzer</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-green-400">${content.length}</div>
                                <div class="text-gray-400">Inhalte</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-yellow-400">${pendingContent}</div>
                                <div class="text-gray-400">Ausstehend</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-purple-400">0</div>
                                <div class="text-gray-400">K√§ufe heute</div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showAdminTab('users')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-users mr-2"></i>Benutzer</button>
                            <button onclick="showAdminTab('content')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-box mr-2"></i>Inhalte</button>
                        </div>

                        <div id="adminContent">
                            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                                <p class="text-gray-400">W√§hle einen Tab aus, um fortzufahren.</p>
                            </div>
                        </div>
                    </div>
                `;
            },

            footer() {
                return `
                    <footer class="bg-gray-900/95 border-t border-gray-800 mt-16">
                        <div class="container mx-auto px-4 py-10">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-8">
                                <div class="col-span-2 md:col-span-1">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <i class="fas fa-cube text-xl text-green-500"></i>
                                        <span class="text-lg font-bold">MCMarket</span>
                                    </div>
                                    <p class="text-gray-500 text-xs">Deine Plattform f√ºr Minecraft Content.</p>
                                </div>
                                
                                <div>
                                    <h4 class="text-white text-sm font-semibold mb-3">Navigation</h4>
                                    <ul class="space-y-2">
                                        <li><a href="#" onclick="Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs transition-colors">Marktplatz</a></li>
                                        <li><a href="#" onclick="Render.navigate('purchases'); return false;" class="text-gray-500 hover:text-white text-xs transition-colors">Meine K√§ufe</a></li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 class="text-white text-sm font-semibold mb-3">Rechtliches</h4>
                                    <ul class="space-y-2">
                                        <li><a href="#" onclick="Legal.showImpressum(); return false;" class="text-gray-500 hover:text-white text-xs transition-colors">Impressum</a></li>
                                        <li><a href="#" onclick="Legal.showDatenschutz(); return false;" class="text-gray-500 hover:text-white text-xs transition-colors">Datenschutz</a></li>
                                        <li><a href="#" onclick="Legal.showAGB(); return false;" class="text-gray-500 hover:text-white text-xs transition-colors">AGB</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-800 pt-6 flex flex-col md:flex-row justify-between items-center gap-3">
                                <p class="text-xs text-gray-600">¬© ${new Date().getFullYear()} MCMarket. Alle Rechte vorbehalten.</p>
                                <div class="flex items-center gap-4 text-xs text-gray-600">
                                    <span class="flex items-center"><i class="fas fa-lock text-green-600 mr-1"></i>SSL</span>
                                    <span class="flex items-center"><i class="fas fa-shield-alt text-blue-600 mr-1"></i>DSGVO</span>
                                </div>
                            </div>
                        </div>
                    </footer>
                `;
            }
        };

        // ============ ADMIN TAB FUNCTIONS ============
        async function showAdminTab(tab) {
            const adminContent = document.getElementById('adminContent');
            if (!adminContent) return;

            adminContent.innerHTML = '<div class="flex justify-center py-8"><div class="spinner"></div></div>';

            const users = await DB.getUsers();
            const content = await DB.getContent();

            switch(tab) {
                case 'users':
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                            <div class="p-4 bg-gray-700/50 border-b border-gray-700">
                                <h3 class="font-bold"><i class="fas fa-users mr-2"></i>Benutzer (${users.length})</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="text-left p-4">Benutzer</th>
                                            <th class="text-left p-4">Rolle</th>
                                            <th class="text-left p-4">Tokens</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${users.map(u => `
                                            <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                                                <td class="p-4">
                                                    <div class="font-bold">${u.username || 'Unbekannt'}</div>
                                                    <div class="text-sm text-gray-400">${u.email}</div>
                                                </td>
                                                <td class="p-4">
                                                    <span class="px-2 py-1 rounded text-xs ${u.role === 'admin' ? 'bg-red-500' : 'bg-blue-500'}">${u.role || 'user'}</span>
                                                </td>
                                                <td class="p-4 text-yellow-400 font-bold">${u.role === 'admin' ? '‚àû' : Utils.formatTokens(u.tokens)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;

                case 'content':
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                            <div class="p-4 bg-gray-700/50 border-b border-gray-700">
                                <h3 class="font-bold"><i class="fas fa-box mr-2"></i>Inhalte (${content.length})</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="text-left p-4">Titel</th>
                                            <th class="text-left p-4">Uploader</th>
                                            <th class="text-left p-4">Preis</th>
                                            <th class="text-left p-4">Status</th>
                                            <th class="text-left p-4">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${content.map(c => `
                                            <tr class="border-t border-gray-700 hover:bg-gray-700/50 ${!c.approved ? 'bg-yellow-500/10' : ''}">
                                                <td class="p-4 font-bold">${c.title}</td>
                                                <td class="p-4 text-gray-400">${c.uploaderName || 'Unbekannt'}</td>
                                                <td class="p-4 text-yellow-400">${c.price} Tokens</td>
                                                <td class="p-4">
                                                    <span class="px-2 py-1 rounded text-xs ${c.approved ? 'bg-green-600' : 'bg-yellow-600'}">${c.approved ? 'OK' : 'Ausstehend'}</span>
                                                </td>
                                                <td class="p-4">
                                                    ${!c.approved ? `<button onclick="adminApproveContent('${c.id}')" class="px-3 py-1 bg-green-600 rounded hover:bg-green-700 mr-2"><i class="fas fa-check"></i></button>` : ''}
                                                    <button onclick="adminDeleteContent('${c.id}')" class="px-3 py-1 bg-red-600 rounded hover:bg-red-700"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // ============ HELPER FUNCTIONS ============
        function toggleProfileDropdown() {
            const menu = document.getElementById('profileMenu');
            if (menu) menu.classList.toggle('hidden');
        }

        function closeProfileDropdown() {
            const menu = document.getElementById('profileMenu');
            if (menu) menu.classList.add('hidden');
        }

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown && !dropdown.contains(e.target)) closeProfileDropdown();
        });

        function showModal(content) {
            const existing = document.getElementById('modal-overlay');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'modal-overlay';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in';
            modal.innerHTML = `<div class="bg-gray-800 rounded-xl border border-gray-700 p-6 max-w-md w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">${content}</div>`;
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            if (modal) modal.remove();
        }

        function handleImagePreview(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImagePreview = event.target.result;
                    const preview = document.getElementById('imagePreview');
                    const img = document.getElementById('previewImg');
                    if (preview && img) {
                        preview.classList.remove('hidden');
                        img.src = uploadedImagePreview;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ EVENT HANDLERS ============
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginTab) loginTab.classList.toggle('bg-green-600', tab === 'login');
            if (registerTab) registerTab.classList.toggle('bg-green-600', tab === 'register');
            if (loginForm) loginForm.classList.toggle('hidden', tab !== 'login');
            if (registerForm) registerForm.classList.toggle('hidden', tab !== 'register');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            Utils.showToast('Anmelden...', 'info');
            
            const user = await Auth.login(email, password);
            if (user) {
                Utils.showToast(`Willkommen, ${user.username || 'User'}!`);
                currentView = 'marketplace';
                await Render.app();
            } else {
                Utils.showToast('Ung√ºltige Anmeldedaten', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value;
            
            if (!document.getElementById('agbCheckbox').checked) {
                Utils.showToast('Bitte AGB akzeptieren', 'error');
                return;
            }
            
            Utils.showToast('Registrieren...', 'info');
            
            const result = await Auth.register(username, email, password);
            if (result.success) {
                Utils.showToast('Willkommen! Account erstellt.');
                currentView = 'marketplace';
                await Render.app();
            } else {
                Utils.showToast(result.error || 'Registrierung fehlgeschlagen', 'error');
            }
        }

        async function handleLogout() {
            await Auth.logout();
            currentView = 'login';
            await Render.app();
            Utils.showToast('Abgemeldet', 'info');
        }

        async function handleClaimTokens() {
            const success = await Auth.claimTokens();
            if (success) {
                Utils.showToast(`+${DB.getSettings().tokenAmount} Tokens!`);
                await Render.app();
            } else {
                Utils.showToast('Tokens noch nicht verf√ºgbar', 'error');
            }
        }

        function updateFilter(key, value) {
            filterState[key] = value;
            Render.marketplace();
        }

        function viewContent(id) {
            selectedContent = id;
            Render.navigate('content-detail');
        }

        async function handlePurchase(id) {
            const result = await Content.purchase(id);
            if (result === true) {
                Utils.showToast('Erfolgreich gekauft!');
                await Render.app();
                await Render.navigate('content-detail');
            } else if (result === 'already') {
                Utils.showToast('Bereits gekauft', 'info');
            } else {
                Utils.showToast('Kauf fehlgeschlagen', 'error');
            }
        }

        async function handleDownload(id) {
            const user = DB.getCurrentUser();
            const allContent = await DB.getContent();
            const item = allContent.find(c => c.id === id);
            
            if (!user || !item) { 
                Utils.showToast('Fehler', 'error'); 
                return; 
            }

            // Download erh√∂hen
            await supabase.from('content').update({ 
                downloads: (item.downloads || 0) + 1 
            }).eq('id', id);

            const savedFile = DB.getFile(id);
            if (savedFile && savedFile.data) {
                try {
                    const byteCharacters = atob(savedFile.data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: savedFile.type || 'application/octet-stream' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = item.fileName || 'download';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    Utils.showToast('Download gestartet!', 'success');
                } catch (e) {
                    console.error('Download-Fehler:', e);
                    Utils.showToast('Download-Fehler', 'error');
                }
            } else {
                Utils.showToast('Keine Datei vorhanden', 'error');
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const title = document.getElementById('uploadTitle').value.trim();
            const description = document.getElementById('uploadDesc').value.trim();
            const category = document.getElementById('uploadCategory').value;
            const price = Math.max(0, parseInt(document.getElementById('uploadPrice').value) || 0);
            const mcVersions = Array.from(document.querySelectorAll('input[name="mcVersion"]:checked')).map(c => c.value);
            const file = document.getElementById('fileInput').files[0];

            if (title.length < 3) { Utils.showToast('Titel zu kurz', 'error'); return; }
            if (description.length < 10) { Utils.showToast('Beschreibung zu kurz', 'error'); return; }
            if (!file) { Utils.showToast('Bitte Datei ausw√§hlen', 'error'); return; }
            if (file.size > 5 * 1024 * 1024) { Utils.showToast('Datei zu gro√ü (max 5MB)', 'error'); return; }

            Utils.showToast('Wird hochgeladen...', 'info');

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const base64Data = event.target.result.split(',')[1];
                    
                    const user = DB.getCurrentUser();
                    const settings = DB.getSettings();
                    const contentId = Utils.generateId();
                    
                    const { data, error } = await supabase.from('content').insert({
                        id: contentId,
                        title: title,
                        description: description,
                        category: category,
                        price: price,
                        mc_versions: mcVersions,
                        visibility: 'public',
                        file_name: file.name,
                        file_size: Utils.formatFileSize(file.size),
                        uploader_id: user.id,
                        uploader_name: user.username || 'Unbekannt',
                        downloads: 0,
                        approved: DB.isAdmin(user) || !settings.requireApproval
                    }).select();

                    if (error) {
                        console.error('Upload Fehler:', error);
                        Utils.showToast('Upload fehlgeschlagen: ' + error.message, 'error');
                        return;
                    }

                    // Datei lokal speichern
                    DB.saveFile(contentId, { data: base64Data, type: file.type, name: file.name, size: file.size });
                    
                    // Bild speichern falls vorhanden
                    if (uploadedImagePreview) {
                        DB.saveImage(contentId, uploadedImagePreview);
                        uploadedImagePreview = null;
                    }

                    Utils.showToast(DB.isAdmin(user) ? 'Ver√∂ffentlicht!' : 'Hochgeladen - wartet auf Genehmigung');
                    await Render.navigate('marketplace');
                } catch (err) {
                    console.error('Upload Exception:', err);
                    Utils.showToast('Upload fehlgeschlagen', 'error');
                }
            };
            
            reader.onerror = function() { 
                Utils.showToast('Fehler beim Lesen der Datei', 'error'); 
            };
            reader.readAsDataURL(file);
        }

        // ============ ADMIN FUNCTIONS ============
        async function adminApproveContent(contentId) {
            const { error } = await supabase.from('content').update({ approved: true }).eq('id', contentId);
            if (!error) {
                Utils.showToast('Genehmigt');
                await Render.navigate('admin');
            } else {
                Utils.showToast('Fehler', 'error');
            }
        }

        async function adminDeleteContent(contentId) {
            if (!confirm('Inhalt wirklich l√∂schen?')) return;
            const { error } = await supabase.from('content').delete().eq('id', contentId);
            if (!error) {
                Utils.showToast('Gel√∂scht');
                await Render.navigate('admin');
            } else {
                Utils.showToast('Fehler', 'error');
            }
        }

        // ============ LEGAL PAGES ============
        const Legal = {
            showImpressum() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-gavel mr-2 text-blue-400"></i>Impressum</h2>
                    <div class="space-y-4 text-sm text-gray-300">
                        <p>MCMarket - Minecraft Content Marketplace</p>
                        <p>Kontakt: mcmarket.2026@gmail.com</p>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Schlie√üen</button>
                `);
            },

            showDatenschutz() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-shield-alt mr-2 text-green-400"></i>Datenschutz</h2>
                    <div class="space-y-4 text-sm text-gray-300 max-h-80 overflow-y-auto">
                        <p>Wir speichern nur die notwendigen Daten f√ºr den Betrieb der Plattform.</p>
                        <ul class="list-disc list-inside">
                            <li>E-Mail-Adresse</li>
                            <li>Benutzername</li>
                            <li>Kaufhistorie</li>
                        </ul>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Schlie√üen</button>
                `);
            },

            showAGB() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-file-contract mr-2 text-yellow-400"></i>AGB</h2>
                    <div class="space-y-4 text-sm text-gray-300 max-h-80 overflow-y-auto">
                        <p>Mit der Nutzung von MCMarket akzeptierst du unsere Nutzungsbedingungen.</p>
                        <ul class="list-disc list-inside">
                            <li>Tokens haben keinen Echtgeldwert</li>
                            <li>K√§ufe sind endg√ºltig</li>
                            <li>Keine illegalen Inhalte</li>
                        </ul>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Schlie√üen</button>
                `);
            }
        };

        // ============ INIT ============
        async function initApp() {
            console.log('MCMarket wird gestartet...');
            
            try {
                await DB.init();
                console.log('DB initialisiert, User:', currentUserData);
                
                if (currentUserData) {
                    currentView = 'marketplace';
                } else {
                    currentView = 'login';
                }
                
                await Render.app();
                console.log('App gerendert');
            } catch (e) {
                console.error('Init Fehler:', e);
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <p class="text-xl text-red-400">Fehler beim Laden</p>
                        <p class="text-gray-400 mt-2">${e.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-green-600 rounded-lg">Neu laden</button>
                    </div>
                `;
            }
        }
        
        // App starten
        initApp();
    </script>
</body>
</html>
