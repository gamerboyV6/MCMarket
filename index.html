<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCMarket - Minecraft Content Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-green-hover: #16a34a;
            --admin-red: #ef4444;
            --admin-red-hover: #dc2626;
            --yellow-token: #fbbf24;
            --bg-dark: #1a1a2e;
            --bg-darker: #16213e;
            --bg-darkest: #0f3460;
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 50%, var(--bg-darkest) 100%);
            min-height: 100vh;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .token-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #fbbf24; }
            to { box-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; }
        }

        .admin-glow {
            animation: adminGlow 2s ease-in-out infinite alternate;
        }

        @keyframes adminGlow {
            from { box-shadow: 0 0 5px #ef4444; }
            to { box-shadow: 0 0 20px #ef4444, 0 0 30px #dc2626; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .dropdown-enter {
            animation: dropdownEnter 0.2s ease-out;
        }

        @keyframes dropdownEnter {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bg-gray-750 {
            background-color: rgba(55, 65, 81, 0.5);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        ::selection {
            background: rgba(34, 197, 94, 0.3);
            color: #fff;
        }

        button, a {
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(34, 197, 94, 0.3);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .gallery-thumb {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .gallery-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner mb-4"></div>
        <p class="text-gray-400">Lade MCMarket...</p>
        <p id="loadingStatus" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <!-- App Container -->
    <div id="app"></div>

    <!-- Supabase laden -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============ SUPABASE CONFIG ============
        const SUPABASE_URL = 'https://lrjyxbwwqenczqucdtgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxyanl4Ynd3cWVuY3pxdWNkdGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNDIzMTQsImV4cCI6MjA4MjYxODMxNH0.j_r0DuYk8HlX-uCxU1hxDCkGYKjBK2dKIIvEObHTefQ';
        
        let supabaseClient = null;
        
        function getSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        
        const ADMIN_EMAIL = 'mcmarket.2026@gmail.com';

        // ============ GLOBAL STATE ============
        let currentUserData = null;
        let cachedSettings = null;
        let currentView = 'login';
        let selectedContent = null;
        let filterState = { category: 'all', priceType: 'all', search: '' };
        let notifications = [];
        let uploadedGalleryImages = [];

        // ============ DEFAULT SETTINGS ============
        const defaultSettings = {
            tokenInterval: 'daily',
            tokenAmount: 10,
            uploadsEnabled: true,
            salesEnabled: true,
            tokenSystemEnabled: true,
            requireApproval: true,
            registrationEnabled: true,
            maintenanceMode: false,
            welcomeTokens: 50
        };

        // ============ LOADING HELPERS ============
        function setLoadingStatus(text) {
            const el = document.getElementById('loadingStatus');
            if (el) el.textContent = text;
        }

        function hideLoading() {
            const el = document.getElementById('loadingScreen');
            if (el) el.style.display = 'none';
        }

        function showError(message) {
            const el = document.getElementById('loadingScreen');
            if (el) {
                el.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <p class="text-xl text-red-400">Fehler beim Laden</p>
                        <p class="text-gray-400 mt-2 max-w-md">${message}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
                            <i class="fas fa-refresh mr-2"></i>Neu laden
                        </button>
                    </div>
                `;
            }
        }

        // ============ DATABASE FUNCTIONS ============
        const DB = {
            async init() {
                setLoadingStatus('Verbinde mit Datenbank...');
                const sb = getSupabase();
                cachedSettings = defaultSettings;

                try {
                    const { data: { session } } = await sb.auth.getSession();
                    
                    if (session && session.user) {
                        setLoadingStatus('Lade Profil...');
                        const { data: profile } = await sb
                            .from('profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            await this.loadNotifications();
                        }
                    }
                    
                    setLoadingStatus('Lade Einstellungen...');
                    const { data: settings } = await sb
                        .from('settings')
                        .select('*')
                        .eq('id', 1)
                        .single();
                    
                    if (settings) {
                        cachedSettings = { 
                            ...defaultSettings, 
                            tokenInterval: settings.token_interval,
                            tokenAmount: settings.token_amount,
                            uploadsEnabled: settings.uploads_enabled,
                            salesEnabled: settings.sales_enabled,
                            tokenSystemEnabled: settings.token_system_enabled,
                            requireApproval: settings.require_approval,
                            registrationEnabled: settings.registration_enabled,
                            maintenanceMode: settings.maintenance_mode,
                            welcomeTokens: settings.welcome_tokens
                        };
                    }
                    
                    return true;
                } catch (e) {
                    console.error('DB Init Fehler:', e);
                    return true;
                }
            },

            async loadNotifications() {
                if (!currentUserData) return;
                const { data } = await getSupabase()
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUserData.id)
                    .eq('is_read', false)
                    .order('created_at', { ascending: false });
                notifications = data || [];
            },
            
            async getContent() { 
                try {
                    const { data, error } = await getSupabase()
                        .from('content')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) return [];
                    
                    return (data || []).map(c => ({
                        ...c,
                        uploaderId: c.uploader_id,
                        uploaderName: c.uploader_name,
                        mcVersions: c.mc_versions || [],
                        fileName: c.file_name,
                        fileSize: c.file_size,
                        fileUrl: c.file_url,
                        imageUrl: c.image_url,
                        galleryUrls: c.gallery_urls || [],
                        createdAt: c.created_at
                    }));
                } catch (e) {
                    return [];
                }
            },
            
            async getUsers() { 
                const { data } = await getSupabase().from('profiles').select('*').order('created_at', { ascending: false });
                return data || [];
            },
            
            async getRoles() {
                const { data } = await getSupabase().from('roles').select('*').order('name');
                return data || [];
            },
            
            async getPurchases() { 
                if (!currentUserData) return [];
                const { data } = await getSupabase()
                    .from('purchases')
                    .select('*')
                    .eq('user_id', currentUserData.id);
                
                return (data || []).map(p => ({
                    ...p,
                    contentId: p.content_id,
                    date: p.created_at
                }));
            },
            
            async getTransactions() { 
                if (!currentUserData) return [];
                const { data } = await getSupabase()
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUserData.id)
                    .order('created_at', { ascending: false });
                
                return data || [];
            },

            async getAdminLogs() {
                const { data } = await getSupabase()
                    .from('admin_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                return data || [];
            },

            async addAdminLog(action, targetType, targetId, details) {
                if (!currentUserData) return;
                await getSupabase().from('admin_logs').insert({
                    admin_id: currentUserData.id,
                    action,
                    target_type: targetType,
                    target_id: targetId,
                    details
                });
            },
            
            getSettings() { 
                return cachedSettings || defaultSettings;
            },

            getCurrentUser() { 
                return currentUserData;
            },

            isAdmin(user) {
                return user && (user.role === 'admin' || user.email === ADMIN_EMAIL);
            },

            isCreator(user) {
                return user && (user.role === 'creator' || this.isAdmin(user));
            },

            // ============ STORAGE FUNCTIONS ============
            async uploadFile(file, contentId) {
                const fileName = `${contentId}_${Date.now()}_${file.name}`;
                const { data, error } = await getSupabase().storage
                    .from('content-files')
                    .upload(fileName, file, { cacheControl: '3600', upsert: true });
                
                if (error) {
                    console.error('Upload error:', error);
                    return null;
                }
                
                const { data: urlData } = getSupabase().storage
                    .from('content-files')
                    .getPublicUrl(fileName);
                
                return urlData.publicUrl;
            },

            async uploadImage(file, contentId, suffix = '') {
                const fileName = `${contentId}_${Date.now()}${suffix}_${file.name}`;
                const { data, error } = await getSupabase().storage
                    .from('content-images')
                    .upload(fileName, file, { cacheControl: '3600', upsert: true });
                
                if (error) {
                    console.error('Image upload error:', error);
                    return null;
                }
                
                const { data: urlData } = getSupabase().storage
                    .from('content-images')
                    .getPublicUrl(fileName);
                
                return urlData.publicUrl;
            }
        };

        // ============ UTILITY FUNCTIONS ============
        const Utils = {
            generateId: () => 'id_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36),
            formatDate: (dateStr) => {
                try {
                    return new Date(dateStr).toLocaleDateString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'N/A';
                }
            },
            
            formatTokens(tokens) {
                if (tokens === Infinity || tokens === 'Infinity' || !isFinite(tokens) || tokens > 900000000) return '‚àû';
                return (tokens || 0).toLocaleString('de-DE');
            },

            showToast(message, type = 'success') {
                const existing = document.querySelectorAll('.toast-msg');
                existing.forEach(el => el.remove());
                
                const toast = document.createElement('div');
                toast.className = `toast-msg fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 fade-in ${
                    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
                toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-times' : 'fa-info'} mr-2"></i>${message}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            getCategoryIcon(cat) {
                const icons = { plugin: 'fa-puzzle-piece', mod: 'fa-cube', texturepack: 'fa-image', world: 'fa-globe' };
                return icons[cat] || 'fa-file';
            },

            getCategoryName(cat) {
                const names = { plugin: 'Plugin', mod: 'Mod', texturepack: 'Texturepack', world: 'Welt' };
                return names[cat] || cat;
            },

            canClaimTokens(user) {
                if (!user || DB.isAdmin(user)) return false;
                const settings = DB.getSettings();
                if (!settings.tokenSystemEnabled) return false;
                if (!user.last_token_claim) return true;
                const last = new Date(user.last_token_claim);
                const now = new Date();
                const diff = now - last;
                const intervals = { hourly: 3600000, daily: 86400000, weekly: 604800000, monthly: 2592000000 };
                return diff >= (intervals[settings.tokenInterval] || 86400000);
            },

            getTimeUntilNextClaim(user) {
                if (!user || DB.isAdmin(user)) return 'Unbegrenzt';
                const settings = DB.getSettings();
                if (!user.last_token_claim) return 'Jetzt verf√ºgbar!';
                const last = new Date(user.last_token_claim);
                const now = new Date();
                const intervals = { hourly: 3600000, daily: 86400000, weekly: 604800000, monthly: 2592000000 };
                const nextClaim = new Date(last.getTime() + (intervals[settings.tokenInterval] || 86400000));
                const diff = nextClaim - now;
                if (diff <= 0) return 'Jetzt verf√ºgbar!';
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                if (hours > 24) return `${Math.floor(hours / 24)}d ${hours % 24}h`;
                return `${hours}h ${minutes}m`;
            },
            
            formatFileSize(bytes) {
                if (!bytes) return 'N/A';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(2) + ' MB';
            }
        };

        // ============ AUTH FUNCTIONS ============
        const Auth = {
            async login(email, password) {
                try {
                    const { data, error } = await getSupabase().auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) return null;
                    
                    if (data.user) {
                        const { data: profile } = await getSupabase()
                            .from('profiles')
                            .select('*')
                            .eq('id', data.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            await DB.loadNotifications();
                            return profile;
                        }
                    }
                    return null;
                } catch (e) {
                    return null;
                }
            },

            async register(username, email, password) {
                try {
                    const settings = DB.getSettings();
                    if (!settings.registrationEnabled) return { error: 'Registrierung deaktiviert' };
                    
                    const { data, error } = await getSupabase().auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { username: username }
                        }
                    });
                    
                    if (error) return { error: error.message };
                    
                    if (data.user) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        const { data: profile } = await getSupabase()
                            .from('profiles')
                            .select('*')
                            .eq('id', data.user.id)
                            .single();
                        
                        if (profile) {
                            currentUserData = profile;
                            return { success: true, user: profile };
                        }
                    }
                    
                    return { success: true, user: data.user };
                } catch (e) {
                    return { error: e.message };
                }
            },

            async logout() {
                await getSupabase().auth.signOut();
                currentUserData = null;
                notifications = [];
            },

            async claimTokens() {
                const user = DB.getCurrentUser();
                if (!user || DB.isAdmin(user)) return false;
                if (!Utils.canClaimTokens(user)) return false;

                const settings = DB.getSettings();
                const newTokens = (user.tokens || 0) + settings.tokenAmount;
                
                const { error } = await getSupabase()
                    .from('profiles')
                    .update({ 
                        tokens: newTokens,
                        last_token_claim: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (!error) {
                    currentUserData.tokens = newTokens;
                    currentUserData.last_token_claim = new Date().toISOString();
                    
                    await getSupabase().from('transactions').insert({
                        user_id: user.id,
                        type: 'earn',
                        amount: settings.tokenAmount,
                        description: `Token-Belohnung (${settings.tokenInterval})`
                    });
                    return true;
                }
                return false;
            }
        };

        // ============ CONTENT FUNCTIONS ============
        const Content = {
            async hasPurchased(contentId) {
                const user = DB.getCurrentUser();
                if (!user) return false;
                if (DB.isAdmin(user)) return true;
                const purchases = await DB.getPurchases();
                return purchases.some(p => p.contentId === contentId);
            },

            async purchase(contentId) {
                const user = DB.getCurrentUser();
                const allContent = await DB.getContent();
                const content = allContent.find(c => c.id === contentId);
                const settings = DB.getSettings();
                const isAdmin = DB.isAdmin(user);

                if (!user || !content) return false;
                
                // Pr√ºfen ob bereits gekauft
                const purchases = await DB.getPurchases();
                if (purchases.find(p => p.contentId === contentId)) return 'already';

                // Verk√§ufe m√ºssen aktiviert sein (au√üer f√ºr Admin)
                if (!settings.salesEnabled && !isAdmin) return false;
                
                // Preis pr√ºfen (Admin zahlt nichts)
                if (!isAdmin && (user.tokens || 0) < content.price) return false;

                // Tokens vom K√§ufer abziehen (nur wenn kein Admin)
                if (!isAdmin) {
                    const newTokens = (user.tokens || 0) - content.price;
                    await getSupabase().from('profiles').update({ tokens: newTokens }).eq('id', user.id);
                    currentUserData.tokens = newTokens;

                    // Transaktion f√ºr K√§ufer
                    await getSupabase().from('transactions').insert({
                        user_id: user.id,
                        type: 'purchase',
                        amount: -content.price,
                        description: `Kauf: ${content.title}`
                    });
                }

                // IMMER Tokens an Creator geben (auch wenn Admin kauft!)
                if (content.price > 0 && content.uploaderId && content.uploaderId !== user.id) {
                    // Creator Tokens geben
                    const { data: creator } = await getSupabase()
                        .from('profiles')
                        .select('*')
                        .eq('id', content.uploaderId)
                        .single();
                    
                    if (creator && creator.role !== 'admin') {
                        const creatorNewTokens = (creator.tokens || 0) + content.price;
                        await getSupabase().from('profiles').update({ tokens: creatorNewTokens }).eq('id', content.uploaderId);

                        // Transaktion f√ºr Creator
                        await getSupabase().from('transactions').insert({
                            user_id: content.uploaderId,
                            type: 'sale',
                            amount: content.price,
                            description: `Verkauf: ${content.title}`
                        });

                        // Benachrichtigung an Creator
                        await getSupabase().from('notifications').insert({
                            user_id: content.uploaderId,
                            type: 'sale',
                            title: 'üí∞ Verkauf!',
                            message: `"${content.title}" wurde gekauft!`,
                            token_amount: content.price
                        });
                    }
                }

                // Kauf speichern
                await getSupabase().from('purchases').insert({
                    user_id: user.id,
                    content_id: contentId,
                    price: isAdmin ? 0 : content.price
                });

                // Download-Z√§hler erh√∂hen
                await getSupabase().from('content').update({ 
                    downloads: (content.downloads || 0) + 1 
                }).eq('id', contentId);

                return true;
            }
        };

        // ============ ADMIN FUNCTIONS ============
        const Admin = {
            async giveTokensToUser(userId, amount, message) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                const { data: targetUser } = await getSupabase()
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (!targetUser) return false;

                const newTokens = (targetUser.tokens || 0) + amount;
                await getSupabase().from('profiles').update({ tokens: newTokens }).eq('id', userId);

                await getSupabase().from('notifications').insert({
                    user_id: userId,
                    type: amount > 0 ? 'token_gift' : 'token_remove',
                    title: amount > 0 ? 'üéÅ Token-Geschenk!' : '‚ö†Ô∏è Tokens abgezogen',
                    message: message || (amount > 0 ? `Du hast ${amount} Tokens erhalten!` : `Dir wurden ${Math.abs(amount)} Tokens abgezogen.`),
                    token_amount: amount,
                    created_by: user.id
                });

                await getSupabase().from('transactions').insert({
                    user_id: userId,
                    type: 'admin_gift',
                    amount: amount,
                    description: message || 'Admin Token-Geschenk'
                });

                await DB.addAdminLog('give_tokens', 'user', userId, { amount, message });
                return true;
            },

            async giveTokensToAll(amount, message) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                const users = await DB.getUsers();
                for (const u of users) {
                    if (u.role !== 'admin') {
                        await this.giveTokensToUser(u.id, amount, message);
                    }
                }

                await DB.addAdminLog('give_tokens_all', 'all', null, { amount, message, user_count: users.length });
                return true;
            },

            async setUserRole(userId, role) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                await getSupabase().from('profiles').update({ role }).eq('id', userId);
                await DB.addAdminLog('change_role', 'user', userId, { new_role: role });
                return true;
            },

            async deleteUser(userId) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                await getSupabase().from('profiles').delete().eq('id', userId);
                await DB.addAdminLog('delete_user', 'user', userId, {});
                return true;
            },

            async approveContent(contentId) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                await getSupabase().from('content').update({ approved: true }).eq('id', contentId);
                await DB.addAdminLog('approve_content', 'content', contentId, {});
                return true;
            },

            async deleteContent(contentId) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                await getSupabase().from('content').delete().eq('id', contentId);
                await DB.addAdminLog('delete_content', 'content', contentId, {});
                return true;
            },

            async updateSettings(newSettings) {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) return false;

                await getSupabase().from('settings').update({
                    token_interval: newSettings.tokenInterval,
                    token_amount: newSettings.tokenAmount,
                    uploads_enabled: newSettings.uploadsEnabled,
                    sales_enabled: newSettings.salesEnabled,
                    token_system_enabled: newSettings.tokenSystemEnabled,
                    require_approval: newSettings.requireApproval,
                    registration_enabled: newSettings.registrationEnabled,
                    maintenance_mode: newSettings.maintenanceMode,
                    welcome_tokens: newSettings.welcomeTokens
                }).eq('id', 1);

                cachedSettings = newSettings;
                await DB.addAdminLog('update_settings', 'settings', '1', newSettings);
                return true;
            }
        };

        // ============ LIGHTBOX ============
        function openLightbox(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.className = 'lightbox';
            lightbox.onclick = () => lightbox.remove();
            lightbox.innerHTML = `
                <button onclick="event.stopPropagation(); this.parentElement.remove();" class="absolute top-4 right-4 w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <img src="${imageUrl}" alt="Bild" onclick="event.stopPropagation();">
            `;
            document.body.appendChild(lightbox);
        }

        // ============ RENDER FUNCTIONS ============
        const Render = {
            app() {
                const user = DB.getCurrentUser();
                const app = document.getElementById('app');
                const settings = DB.getSettings();

                hideLoading();

                if (settings.maintenanceMode && (!user || !DB.isAdmin(user))) {
                    app.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-tools text-6xl text-yellow-500 mb-4"></i>
                                <h1 class="text-3xl font-bold mb-2">Wartungsmodus</h1>
                                <p class="text-gray-400">Die Seite ist vor√ºbergehend nicht verf√ºgbar.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (!user) {
                    this.authPage();
                    return;
                }

                app.innerHTML = `
                    ${this.navbar()}
                    <main class="container mx-auto px-4 py-6 min-h-screen">
                        <div id="content"></div>
                    </main>
                    ${this.footer()}
                `;

                if (notifications.length > 0) {
                    this.showNotificationPopup();
                }

                this.navigate(currentView);
            },

            showNotificationPopup() {
                const unclaimedNotifs = notifications.filter(n => !n.is_claimed && n.token_amount > 0);
                if (unclaimedNotifs.length === 0) return;

                const notif = unclaimedNotifs[0];
                showModal(`
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full ${notif.token_amount > 0 ? 'bg-yellow-500/20' : 'bg-red-500/20'} flex items-center justify-center">
                            <i class="fas ${notif.token_amount > 0 ? 'fa-gift' : 'fa-exclamation'} text-4xl ${notif.token_amount > 0 ? 'text-yellow-400' : 'text-red-400'}"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">${notif.title}</h2>
                        <p class="text-gray-300 mb-4">${notif.message}</p>
                        ${notif.token_amount !== 0 ? `
                            <div class="text-3xl font-bold ${notif.token_amount > 0 ? 'text-yellow-400' : 'text-red-400'} mb-4">
                                ${notif.token_amount > 0 ? '+' : ''}${notif.token_amount} Tokens
                            </div>
                        ` : ''}
                        <button onclick="claimNotification('${notif.id}')" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                            <i class="fas fa-check mr-2"></i>Verstanden
                        </button>
                    </div>
                `);
            },

            navbar() {
                const user = DB.getCurrentUser();
                const settings = DB.getSettings();
                const isAdmin = DB.isAdmin(user);
                const canClaim = !isAdmin && Utils.canClaimTokens(user);
                const unreadNotifs = notifications.filter(n => !n.is_read).length;

                return `
                    <nav class="bg-gray-900/80 backdrop-blur-sm border-b ${isAdmin ? 'border-red-500/50' : 'border-gray-700'} sticky top-0 z-40">
                        <div class="container mx-auto px-4">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center space-x-8">
                                    <div class="flex items-center space-x-2 cursor-pointer" onclick="Render.navigate('marketplace')">
                                        <i class="fas fa-cube text-2xl text-green-500"></i>
                                        <span class="text-xl font-bold">MCMarket</span>
                                        ${isAdmin ? '<span class="text-xs bg-red-500 px-2 py-0.5 rounded">ADMIN</span>' : ''}
                                    </div>
                                    <div class="hidden md:flex space-x-4">
                                        <button onclick="Render.navigate('marketplace')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-store mr-2"></i>Marktplatz
                                        </button>
                                        <button onclick="Render.navigate('purchases')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-shopping-bag mr-2"></i>Meine K√§ufe
                                        </button>
                                        ${DB.isCreator(user) ? `<button onclick="Render.navigate('upload')" class="px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <i class="fas fa-upload mr-2"></i>Hochladen
                                        </button>` : ''}
                                        ${isAdmin ? `<button onclick="Render.navigate('admin')" class="px-3 py-2 rounded-lg bg-red-500/20 border border-red-500/50 text-red-400 hover:bg-red-500/30 transition"><i class="fas fa-crown mr-2"></i>Admin</button>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <button onclick="showNotificationsModal()" class="relative p-2 hover:bg-gray-700 rounded-lg transition">
                                        <i class="fas fa-bell text-gray-400"></i>
                                        ${unreadNotifs > 0 ? `<span class="notification-badge">${unreadNotifs}</span>` : ''}
                                    </button>

                                    ${settings.tokenSystemEnabled ? `
                                        <div class="flex items-center space-x-2">
                                            ${isAdmin ? `
                                                <div class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-red-500/20 border border-red-500 admin-glow">
                                                    <i class="fas fa-infinity text-red-400"></i>
                                                    <span class="font-bold text-red-400">‚àû</span>
                                                </div>
                                            ` : `
                                                <button onclick="handleClaimTokens()" class="flex items-center space-x-2 px-4 py-2 rounded-lg ${canClaim ? 'bg-yellow-500/20 border border-yellow-500 token-glow cursor-pointer hover:bg-yellow-500/30' : 'bg-gray-700'} transition">
                                                    <i class="fas fa-coins text-yellow-400"></i>
                                                    <span class="font-bold text-yellow-400">${Utils.formatTokens(user.tokens)}</span>
                                                    ${canClaim ? '<i class="fas fa-gift text-green-400 ml-2"></i>' : ''}
                                                </button>
                                            `}
                                        </div>
                                    ` : ''}
                                    <div class="relative" id="profileDropdown">
                                        <button onclick="toggleProfileDropdown()" class="flex items-center space-x-2 px-3 py-2 rounded hover:bg-gray-700 transition">
                                            <div class="w-8 h-8 rounded-full ${isAdmin ? 'bg-gradient-to-br from-red-400 to-yellow-500' : 'bg-gradient-to-br from-green-400 to-blue-500'} flex items-center justify-center">
                                                ${isAdmin ? '<i class="fas fa-crown text-sm"></i>' : (user.username || 'U').charAt(0).toUpperCase()}
                                            </div>
                                            <span class="hidden md:block">${user.username || 'User'}</span>
                                            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                                        </button>
                                        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50 overflow-hidden dropdown-enter">
                                            <div class="px-4 py-3 border-b border-gray-700 bg-gray-750">
                                                <p class="font-bold">${user.username || 'User'}</p>
                                                <p class="text-sm text-gray-400">${user.email}</p>
                                            </div>
                                            <div class="py-1">
                                                <button onclick="Render.navigate('profile'); closeProfileDropdown();" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                                                    <i class="fas fa-user mr-3 text-blue-400"></i>Mein Profil
                                                </button>
                                                <button onclick="Render.navigate('my-content'); closeProfileDropdown();" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                                                    <i class="fas fa-box mr-3 text-purple-400"></i>Meine Inhalte
                                                </button>
                                                <button onclick="exportUserData(); closeProfileDropdown();" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center">
                                                    <i class="fas fa-download mr-3 text-green-400"></i>Daten exportieren
                                                </button>
                                            </div>
                                            <div class="border-t border-gray-700 py-1">
                                                <button onclick="handleLogout()" class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center text-red-400">
                                                    <i class="fas fa-sign-out-alt mr-3"></i>Abmelden
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
            },

            authPage() {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-8 w-full max-w-md border border-gray-700 fade-in">
                            <div class="text-center mb-8">
                                <i class="fas fa-cube text-5xl text-green-500 mb-4"></i>
                                <h1 class="text-3xl font-bold">MCMarket</h1>
                                <p class="text-gray-400 mt-2">Minecraft Content Marketplace</p>
                            </div>
                            
                            <div class="flex mb-6 bg-gray-700/50 rounded-lg p-1">
                                <button id="loginTab" onclick="switchAuthTab('login')" class="flex-1 py-2 rounded-lg bg-green-600 transition">Login</button>
                                <button id="registerTab" onclick="switchAuthTab('register')" class="flex-1 py-2 rounded-lg transition">Registrieren</button>
                            </div>

                            <form id="loginForm" onsubmit="handleLogin(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">E-Mail</label>
                                        <input type="email" id="loginEmail" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Passwort</label>
                                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                        <i class="fas fa-sign-in-alt mr-2"></i>Anmelden
                                    </button>
                                </div>
                            </form>

                            <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Benutzername</label>
                                        <input type="text" id="regUsername" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">E-Mail</label>
                                        <input type="email" id="regEmail" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-1">Passwort</label>
                                        <input type="password" id="regPassword" required minlength="6" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <input type="checkbox" id="agbCheckbox" required class="mt-1 w-4 h-4 accent-green-500">
                                        <label for="agbCheckbox" class="text-sm text-gray-400">
                                            Ich akzeptiere die <a href="#" onclick="Legal.showAGB(); return false;" class="text-green-400 hover:underline">AGB</a> und 
                                            <a href="#" onclick="Legal.showDatenschutz(); return false;" class="text-green-400 hover:underline">Datenschutzerkl√§rung</a>
                                        </label>
                                    </div>
                                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                        <i class="fas fa-user-plus mr-2"></i>Registrieren
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            async navigate(view) {
                currentView = view;
                const content = document.getElementById('content');
                if (!content) return;

                content.innerHTML = '<div class="flex justify-center py-16"><div class="spinner"></div></div>';

                switch(view) {
                    case 'marketplace': await this.marketplace(); break;
                    case 'purchases': await this.purchases(); break;
                    case 'upload': this.upload(); break;
                    case 'admin': await this.admin(); break;
                    case 'profile': await this.profile(); break;
                    case 'my-content': await this.myContent(); break;
                    case 'content-detail': await this.contentDetail(); break;
                    default: await this.marketplace();
                }
            },

            async marketplace() {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const allContent = await DB.getContent();
                const content = isAdmin ? allContent : allContent.filter(c => c.approved && c.visibility === 'public');
                const filteredContent = this.filterContent(content);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <div>
                                <h1 class="text-3xl font-bold"><i class="fas fa-store mr-3 text-green-500"></i>Marktplatz</h1>
                                <p class="text-gray-400 mt-1">${content.length} Inhalte verf√ºgbar</p>
                            </div>
                            <input type="text" id="searchInput" placeholder="Suchen..." class="px-4 py-2 bg-gray-700 rounded-lg" value="${filterState.search}" oninput="updateFilter('search', this.value)">
                        </div>

                        <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-800/30 rounded-xl border border-gray-700/50">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Kategorie</label>
                                <select onchange="updateFilter('category', this.value)" class="px-3 py-2 bg-gray-700/50 rounded-lg border border-gray-600 text-sm">
                                    <option value="all" ${filterState.category === 'all' ? 'selected' : ''}>Alle</option>
                                    <option value="plugin" ${filterState.category === 'plugin' ? 'selected' : ''}>Plugins</option>
                                    <option value="mod" ${filterState.category === 'mod' ? 'selected' : ''}>Mods</option>
                                    <option value="texturepack" ${filterState.category === 'texturepack' ? 'selected' : ''}>Texturepacks</option>
                                    <option value="world" ${filterState.category === 'world' ? 'selected' : ''}>Welten</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Preis</label>
                                <select onchange="updateFilter('priceType', this.value)" class="px-3 py-2 bg-gray-700/50 rounded-lg border border-gray-600 text-sm">
                                    <option value="all" ${filterState.priceType === 'all' ? 'selected' : ''}>Alle</option>
                                    <option value="free" ${filterState.priceType === 'free' ? 'selected' : ''}>Kostenlos</option>
                                    <option value="paid" ${filterState.priceType === 'paid' ? 'selected' : ''}>Kostenpflichtig</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filteredContent.map(item => this.contentCard(item)).join('')}
                        </div>

                        ${filteredContent.length === 0 ? `
                            <div class="text-center py-16 bg-gray-800/30 rounded-xl border border-gray-700/50">
                                <i class="fas fa-box-open text-6xl text-gray-600 mb-4"></i>
                                <p class="text-xl font-bold mb-2">Keine Inhalte gefunden</p>
                                <button onclick="Render.navigate('upload')" class="mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                    <i class="fas fa-upload mr-2"></i>Jetzt hochladen
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            filterContent(content) {
                return content.filter(item => {
                    if (filterState.category !== 'all' && item.category !== filterState.category) return false;
                    if (filterState.priceType === 'free' && item.price > 0) return false;
                    if (filterState.priceType === 'paid' && item.price === 0) return false;
                    if (filterState.search && !item.title.toLowerCase().includes(filterState.search.toLowerCase())) return false;
                    return true;
                });
            },

            contentCard(item) {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const canAfford = isAdmin || (user.tokens || 0) >= item.price;

                return `
                    <div class="bg-gray-800/50 rounded-xl overflow-hidden card-hover border ${!item.approved ? 'border-yellow-500' : 'border-gray-700'} cursor-pointer" onclick="viewContent('${item.id}')">
                        <div class="h-40 bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center relative overflow-hidden">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover" alt="${item.title}">` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-5xl text-white/30"></i>`}
                            <div class="absolute top-3 left-3 px-2 py-1 text-xs rounded-lg bg-black/50">
                                <i class="fas ${Utils.getCategoryIcon(item.category)} mr-1"></i>${Utils.getCategoryName(item.category)}
                            </div>
                            ${!item.approved ? `<span class="absolute top-3 right-3 px-2 py-1 text-xs rounded bg-yellow-500">Ausstehend</span>` :
                              item.price === 0 ? `<span class="absolute top-3 right-3 px-2 py-1 text-xs rounded bg-green-500 font-bold">GRATIS</span>` : ''}
                            ${item.galleryUrls && item.galleryUrls.length > 0 ? `<span class="absolute bottom-3 right-3 px-2 py-1 text-xs rounded bg-black/50"><i class="fas fa-images mr-1"></i>${item.galleryUrls.length + 1}</span>` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-1 truncate">${item.title}</h3>
                            <p class="text-gray-500 text-xs mb-2">von ${item.uploaderName || 'Unbekannt'}</p>
                            <p class="text-gray-400 text-sm mb-3 line-clamp-2">${(item.description || '').substring(0, 60)}...</p>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                                <span class="text-xs text-gray-500"><i class="fas fa-download mr-1"></i>${item.downloads || 0}</span>
                                <span class="font-bold ${item.price === 0 || isAdmin ? 'text-green-400' : canAfford ? 'text-yellow-400' : 'text-red-400'}">
                                    ${isAdmin ? '‚àû' : item.price === 0 ? 'Gratis' : item.price + ' Tokens'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            },

            async contentDetail() {
                const allContent = await DB.getContent();
                const item = allContent.find(c => c.id === selectedContent);
                if (!item) { await this.navigate('marketplace'); return; }

                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const purchased = await Content.hasPurchased(item.id);
                const canAfford = isAdmin || (user.tokens || 0) >= item.price;
                const isOwner = item.uploaderId === user.id;
                const canEdit = isOwner || isAdmin;

                // Alle Bilder (Vorschau + Galerie)
                const allImages = [item.imageUrl, ...(item.galleryUrls || [])].filter(Boolean);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto">
                        <button onclick="Render.navigate('marketplace')" class="mb-6 text-gray-400 hover:text-white">
                            <i class="fas fa-arrow-left mr-2"></i>Zur√ºck
                        </button>

                        <div class="bg-gray-800/50 rounded-2xl overflow-hidden border border-gray-700">
                            <!-- Hauptbild -->
                            <div class="h-80 bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center relative overflow-hidden">
                                ${item.imageUrl ? `
                                    <img src="${item.imageUrl}" class="w-full h-full object-cover cursor-pointer" alt="${item.title}" onclick="openLightbox('${item.imageUrl}')">
                                ` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-8xl text-gray-600"></i>`}
                                ${allImages.length > 1 ? `<span class="absolute bottom-4 right-4 px-3 py-1 bg-black/60 rounded-lg text-sm"><i class="fas fa-images mr-2"></i>${allImages.length} Bilder</span>` : ''}
                            </div>

                            <!-- Galerie Thumbnails -->
                            ${allImages.length > 1 ? `
                                <div class="flex gap-2 p-4 bg-gray-900/50 overflow-x-auto">
                                    ${allImages.map((img, i) => `
                                        <img src="${img}" class="w-20 h-20 object-cover rounded-lg gallery-thumb ${i === 0 ? 'ring-2 ring-green-500' : ''}" onclick="openLightbox('${img}')" alt="Bild ${i + 1}">
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div class="p-8">
                                <div class="flex flex-col md:flex-row justify-between gap-6 mb-8">
                                    <div class="flex-1">
                                        <h1 class="text-3xl font-bold mb-2">${item.title} ${item.version ? `<span class="text-lg text-gray-400">v${item.version}</span>` : ''}</h1>
                                        <p class="text-gray-400 mb-4">von <span class="text-green-400">${item.uploaderName || 'Unbekannt'}</span> ‚Ä¢ ${Utils.formatDate(item.createdAt)}</p>
                                        <div class="flex items-center gap-4 text-sm text-gray-400">
                                            <span><i class="fas fa-download mr-1"></i>${item.downloads || 0} Downloads</span>
                                            <span><i class="fas fa-file mr-1"></i>${item.fileSize || 'N/A'}</span>
                                            ${item.version ? `<span><i class="fas fa-code-branch mr-1"></i>Version ${item.version}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-3">
                                        <div class="text-3xl font-bold ${item.price === 0 || isAdmin ? 'text-green-400' : 'text-yellow-400'}">
                                            ${isAdmin ? '‚àû Kostenlos' : item.price === 0 ? 'Kostenlos' : item.price + ' Tokens'}
                                        </div>
                                        
                                        ${purchased || isOwner || item.price === 0 || isAdmin ? `
                                            <button onclick="handleDownload('${item.id}')" class="px-8 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                                <i class="fas fa-download mr-2"></i>Herunterladen
                                            </button>
                                        ` : canAfford ? `
                                            <button onclick="handlePurchase('${item.id}')" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold">
                                                <i class="fas fa-shopping-cart mr-2"></i>Kaufen
                                            </button>
                                        ` : `
                                            <button disabled class="px-8 py-3 bg-gray-600 rounded-lg font-bold cursor-not-allowed">
                                                <i class="fas fa-lock mr-2"></i>Nicht genug Tokens
                                            </button>
                                        `}

                                        ${canEdit ? `
                                            <div class="flex gap-2">
                                                <button onclick="showEditContentModal('${item.id}')" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg">
                                                    <i class="fas fa-edit mr-1"></i>Bearbeiten
                                                </button>
                                                ${isAdmin ? `
                                                    <button onclick="adminDeleteContent('${item.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">
                                                        <i class="fas fa-trash mr-1"></i>L√∂schen
                                                    </button>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h2 class="text-xl font-bold mb-3">Beschreibung</h2>
                                    <p class="text-gray-300 whitespace-pre-wrap">${item.description || 'Keine Beschreibung'}</p>
                                </div>

                                ${item.mcVersions && item.mcVersions.length > 0 ? `
                                    <div class="mb-8">
                                        <h2 class="text-xl font-bold mb-3">Unterst√ºtzte Versionen</h2>
                                        <div class="flex flex-wrap gap-2">
                                            ${item.mcVersions.map(v => `<span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full">${v}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            async myContent() {
                const user = DB.getCurrentUser();
                const allContent = await DB.getContent();
                const myContent = allContent.filter(c => c.uploaderId === user.id);

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-box mr-3 text-purple-500"></i>Meine Inhalte</h1>
                        
                        ${myContent.length === 0 ? `
                            <div class="text-center py-16 bg-gray-800/30 rounded-xl border border-gray-700/50">
                                <i class="fas fa-box-open text-6xl text-gray-600 mb-4"></i>
                                <p class="text-xl mb-4">Du hast noch keine Inhalte hochgeladen</p>
                                <button onclick="Render.navigate('upload')" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                    <i class="fas fa-upload mr-2"></i>Jetzt hochladen
                                </button>
                            </div>
                        ` : `
                            <div class="grid gap-4">
                                ${myContent.map(item => `
                                    <div class="bg-gray-800/30 rounded-xl p-4 flex items-center justify-between border border-gray-700/50">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden">
                                                ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover">` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-2xl text-gray-500"></i>`}
                                            </div>
                                            <div>
                                                <h3 class="font-bold">${item.title}</h3>
                                                <p class="text-sm text-gray-500">
                                                    ${Utils.getCategoryName(item.category)} ‚Ä¢ 
                                                    ${item.downloads || 0} Downloads ‚Ä¢
                                                    <span class="${item.approved ? 'text-green-400' : 'text-yellow-400'}">${item.approved ? 'Genehmigt' : 'Ausstehend'}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="viewContent('${item.id}')" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="showEditContentModal('${item.id}')" class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            async purchases() {
                const purchases = await DB.getPurchases();
                const allContent = await DB.getContent();

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-shopping-bag mr-3 text-green-500"></i>Meine K√§ufe</h1>
                        
                        ${purchases.length === 0 ? `
                            <div class="text-center py-16 bg-gray-800/30 rounded-xl border border-gray-700/50">
                                <i class="fas fa-shopping-cart text-6xl text-gray-600 mb-4"></i>
                                <p class="text-xl mb-4">Noch keine K√§ufe</p>
                                <button onclick="Render.navigate('marketplace')" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                    <i class="fas fa-store mr-2"></i>Zum Marktplatz
                                </button>
                            </div>
                        ` : `
                            <div class="grid gap-4">
                                ${purchases.map(p => {
                                    const item = allContent.find(c => c.id === p.contentId);
                                    if (!item) return '';
                                    return `
                                        <div class="bg-gray-800/30 rounded-xl p-4 flex items-center justify-between border border-gray-700/50">
                                            <div class="flex items-center space-x-4">
                                                <div class="w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center overflow-hidden">
                                                    ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover">` : `<i class="fas ${Utils.getCategoryIcon(item.category)} text-2xl text-gray-500"></i>`}
                                                </div>
                                                <div>
                                                    <h3 class="font-bold">${item.title}</h3>
                                                    <p class="text-sm text-gray-500">${Utils.formatDate(p.date)}</p>
                                                </div>
                                            </div>
                                            <button onclick="handleDownload('${item.id}')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
                                                <i class="fas fa-download mr-2"></i>Download
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            upload() {
                const user = DB.getCurrentUser();
                const settings = DB.getSettings();
                const isAdmin = DB.isAdmin(user);
                const isCreator = DB.isCreator(user);
                uploadedGalleryImages = [];

                // Nur Creator und Admins k√∂nnen hochladen
                if (!isCreator) {
                    document.getElementById('content').innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                            <p class="text-xl mb-2">Keine Berechtigung</p>
                            <p class="text-gray-400">Nur Creator und Admins k√∂nnen Inhalte hochladen.</p>
                            <p class="text-gray-500 text-sm mt-4">Kontaktiere einen Admin, um Creator zu werden.</p>
                        </div>
                    `;
                    return;
                }

                if (!settings.uploadsEnabled && !isAdmin) {
                    document.getElementById('content').innerHTML = `
                        <div class="text-center py-16">
                            <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                            <p class="text-xl">Uploads sind deaktiviert</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-2xl mx-auto">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-upload mr-3 text-green-500"></i>Inhalt hochladen</h1>
                        
                        <form onsubmit="handleUpload(event)" class="bg-gray-800/50 rounded-xl p-6 border border-gray-700 space-y-6">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Titel *</label>
                                <input type="text" id="uploadTitle" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Beschreibung *</label>
                                <textarea id="uploadDesc" required rows="4" class="w-full px-4 py-3 bg-gray-700 rounded-lg"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Kategorie</label>
                                    <select id="uploadCategory" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                        <option value="plugin">Plugin</option>
                                        <option value="mod">Mod</option>
                                        <option value="texturepack">Texturepack</option>
                                        <option value="world">Welt</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Version *</label>
                                    <input type="text" id="uploadVersion" required placeholder="z.B. 1.0, Beta, Alpha" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Preis (Tokens)</label>
                                <input type="number" id="uploadPrice" min="0" value="0" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                            </div>

                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Minecraft Versionen</label>
                                <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-gray-700/50 rounded-lg">
                                    ${['1.21', '1.20.4', '1.20.1', '1.19.4', '1.18.2', '1.17.1', '1.16.5', '1.12.2', '1.8.9'].map(v => `
                                        <label class="flex items-center space-x-2 px-3 py-2 bg-gray-600 rounded-lg cursor-pointer hover:bg-gray-500">
                                            <input type="checkbox" name="mcVersion" value="${v}" class="accent-green-500">
                                            <span>${v}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Vorschaubild -->
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Vorschaubild (Thumbnail) *</label>
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-green-500 transition cursor-pointer" onclick="document.getElementById('thumbnailInput').click()">
                                    <div id="thumbnailPreview" class="hidden mb-4">
                                        <img id="thumbnailImg" class="max-h-40 mx-auto rounded-lg">
                                    </div>
                                    <i class="fas fa-image text-3xl text-gray-500 mb-2"></i>
                                    <p class="text-gray-400">Vorschaubild hochladen</p>
                                    <input type="file" id="thumbnailInput" class="hidden" accept="image/*" required onchange="handleThumbnailPreview(event)">
                                </div>
                            </div>

                            <!-- Galerie Bilder -->
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Galerie Bilder (optional, max. 5)</label>
                                <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('galleryInput').click()">
                                    <i class="fas fa-images text-3xl text-gray-500 mb-2"></i>
                                    <p class="text-gray-400">Weitere Bilder hinzuf√ºgen</p>
                                    <input type="file" id="galleryInput" class="hidden" accept="image/*" multiple onchange="handleGalleryPreview(event)">
                                </div>
                                <div id="galleryPreviewContainer" class="image-preview-container mt-4"></div>
                            </div>

                            <!-- Datei -->
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Datei * (max 50MB)</label>
                                <input type="file" id="fileInput" required accept=".jar,.zip,.sk,.yml,.json,.mcpack,.mcworld" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                <p id="fileName" class="mt-2 text-green-400"></p>
                            </div>

                            <button type="submit" id="uploadBtn" class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                <i class="fas fa-upload mr-2"></i>Hochladen
                            </button>
                        </form>
                    </div>
                `;

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        document.getElementById('fileName').textContent = '‚úì ' + e.target.files[0].name;
                    }
                });
            },

            async profile() {
                const user = DB.getCurrentUser();
                const isAdmin = DB.isAdmin(user);
                const transactions = await DB.getTransactions();

                document.getElementById('content').innerHTML = `
                    <div class="fade-in max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-user mr-3 text-green-500"></i>Mein Profil</h1>

                        <div class="bg-gray-800/50 rounded-xl p-6 border ${isAdmin ? 'border-red-500' : 'border-gray-700'} mb-6">
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="w-20 h-20 rounded-full ${isAdmin ? 'bg-gradient-to-br from-red-400 to-yellow-500 admin-glow' : 'bg-gradient-to-br from-green-400 to-blue-500'} flex items-center justify-center text-3xl font-bold">
                                    ${isAdmin ? '<i class="fas fa-crown"></i>' : (user.username || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">${user.username || 'User'}</h2>
                                    <p class="text-gray-400">${user.email}</p>
                                    <span class="text-xs px-2 py-1 rounded ${isAdmin ? 'bg-red-500' : 'bg-blue-500'}">${user.role || 'user'}</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold ${isAdmin ? 'text-red-400' : 'text-yellow-400'}">${isAdmin ? '‚àû' : Utils.formatTokens(user.tokens)}</div>
                                    <div class="text-xs text-gray-400">Tokens</div>
                                </div>
                                <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-400">${Utils.formatDate(user.created_at)}</div>
                                    <div class="text-xs text-gray-400">Mitglied seit</div>
                                </div>
                            </div>
                        </div>

                        <!-- DSGVO Datenexport -->
                        <div class="bg-blue-500/10 rounded-xl p-6 border border-blue-500/50 mb-6">
                            <h3 class="font-bold mb-2 text-blue-400"><i class="fas fa-shield-alt mr-2"></i>Deine Daten (DSGVO)</h3>
                            <p class="text-gray-400 text-sm mb-4">Lade alle √ºber dich gespeicherten Daten herunter.</p>
                            <button onclick="exportUserData()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">
                                <i class="fas fa-download mr-2"></i>Daten herunterladen (JSON)
                            </button>
                        </div>

                        <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold mb-4"><i class="fas fa-history mr-2 text-yellow-400"></i>Transaktionen</h3>
                            ${transactions.length === 0 ? '<p class="text-gray-400">Keine Transaktionen</p>' : `
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    ${transactions.slice(0, 20).map(t => `
                                        <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                                            <div class="flex items-center">
                                                <i class="fas ${t.amount > 0 ? 'fa-arrow-down text-green-400' : 'fa-arrow-up text-red-400'} mr-3"></i>
                                                <span class="${t.amount > 0 ? 'text-green-400' : 'text-red-400'} font-bold">${t.amount > 0 ? '+' : ''}${t.amount}</span>
                                                <span class="text-gray-400 ml-2">${t.description || 'Transaktion'}</span>
                                            </div>
                                            <span class="text-sm text-gray-500">${Utils.formatDate(t.created_at)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            },

            async admin() {
                const user = DB.getCurrentUser();
                if (!DB.isAdmin(user)) {
                    document.getElementById('content').innerHTML = '<div class="text-center py-16"><i class="fas fa-shield-alt text-5xl text-red-500 mb-4"></i><p class="text-xl">Zugriff verweigert</p></div>';
                    return;
                }

                const users = await DB.getUsers();
                const content = await DB.getContent();
                const pendingContent = content.filter(c => !c.approved).length;

                document.getElementById('content').innerHTML = `
                    <div class="fade-in">
                        <h1 class="text-3xl font-bold mb-8"><i class="fas fa-crown mr-3 text-red-500"></i>Admin Panel</h1>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-blue-400">${users.length}</div>
                                <div class="text-gray-400">Benutzer</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-green-400">${content.length}</div>
                                <div class="text-gray-400">Inhalte</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-yellow-400">${pendingContent}</div>
                                <div class="text-gray-400">Ausstehend</div>
                            </div>
                            <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                                <div class="text-3xl font-bold text-purple-400">${notifications.length}</div>
                                <div class="text-gray-400">Benachr.</div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showAdminTab('tokens')" class="px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700"><i class="fas fa-coins mr-2"></i>Tokens</button>
                            <button onclick="showAdminTab('users')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-users mr-2"></i>Benutzer</button>
                            <button onclick="showAdminTab('content')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-box mr-2"></i>Inhalte</button>
                            <button onclick="showAdminTab('settings')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-cog mr-2"></i>Einstellungen</button>
                            <button onclick="showAdminTab('logs')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600"><i class="fas fa-history mr-2"></i>Logs</button>
                        </div>

                        <div id="adminContent"></div>
                    </div>
                `;

                showAdminTab('tokens');
            },

            footer() {
                const user = DB.getCurrentUser();
                const isCreator = DB.isCreator(user);
                
                return `
                    <footer class="bg-gray-900/95 border-t border-gray-800 mt-16">
                        <div class="container mx-auto px-4 py-10">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-8">
                                <!-- Brand -->
                                <div class="col-span-2 md:col-span-1">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <i class="fas fa-cube text-xl text-green-500"></i>
                                        <span class="text-lg font-bold">MCMarket</span>
                                    </div>
                                    <p class="text-gray-500 text-xs mb-4">Dein Marktplatz f√ºr Minecraft Plugins, Mods, Texturepacks und Welten.</p>
                                </div>
                                
                                <!-- Navigation -->
                                <div>
                                    <h4 class="text-white text-sm font-semibold mb-3">Navigation</h4>
                                    <ul class="space-y-2">
                                        <li><a href="#" onclick="Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs">Marktplatz</a></li>
                                        <li><a href="#" onclick="Render.navigate('purchases'); return false;" class="text-gray-500 hover:text-white text-xs">Meine K√§ufe</a></li>
                                        <li><a href="#" onclick="Render.navigate('profile'); return false;" class="text-gray-500 hover:text-white text-xs">Profil</a></li>
                                        ${isCreator ? `<li><a href="#" onclick="Render.navigate('upload'); return false;" class="text-gray-500 hover:text-white text-xs">Hochladen</a></li>` : ''}
                                    </ul>
                                </div>
                                
                                <!-- Kategorien -->
                                <div>
                                    <h4 class="text-white text-sm font-semibold mb-3">Kategorien</h4>
                                    <ul class="space-y-2">
                                        <li><a href="#" onclick="filterState.category='plugin'; Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs flex items-center"><i class="fas fa-puzzle-piece w-4 text-green-500 mr-2"></i>Plugins</a></li>
                                        <li><a href="#" onclick="filterState.category='mod'; Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs flex items-center"><i class="fas fa-cube w-4 text-blue-500 mr-2"></i>Mods</a></li>
                                        <li><a href="#" onclick="filterState.category='texturepack'; Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs flex items-center"><i class="fas fa-image w-4 text-purple-500 mr-2"></i>Texturepacks</a></li>
                                        <li><a href="#" onclick="filterState.category='world'; Render.navigate('marketplace'); return false;" class="text-gray-500 hover:text-white text-xs flex items-center"><i class="fas fa-globe w-4 text-cyan-500 mr-2"></i>Welten</a></li>
                                    </ul>
                                </div>
                                
                                <!-- Rechtliches -->
                                <div>
                                    <h4 class="text-white text-sm font-semibold mb-3">Rechtliches</h4>
                                    <ul class="space-y-2">
                                        <li><a href="#" onclick="Legal.showImpressum(); return false;" class="text-gray-500 hover:text-white text-xs">Impressum</a></li>
                                        <li><a href="#" onclick="Legal.showDatenschutz(); return false;" class="text-gray-500 hover:text-white text-xs">Datenschutz</a></li>
                                        <li><a href="#" onclick="Legal.showAGB(); return false;" class="text-gray-500 hover:text-white text-xs">AGB</a></li>
                                        <li><a href="#" onclick="Legal.showKontakt(); return false;" class="text-gray-500 hover:text-white text-xs">Kontakt</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Bottom Bar -->
                            <div class="border-t border-gray-800 pt-6 flex flex-col md:flex-row justify-between items-center gap-3">
                                <p class="text-xs text-gray-600">¬© ${new Date().getFullYear()} MCMarket. Alle Rechte vorbehalten.</p>
                                <div class="flex items-center gap-4 text-xs text-gray-600">
                                    <span class="flex items-center"><i class="fas fa-lock text-green-600 mr-1"></i>SSL</span>
                                    <span class="flex items-center"><i class="fas fa-shield-alt text-blue-600 mr-1"></i>DSGVO</span>
                                </div>
                            </div>
                        </div>
                    </footer>
                `;
            }
        };

        // ============ IMAGE PREVIEW FUNCTIONS ============
        function handleThumbnailPreview(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('thumbnailPreview').classList.remove('hidden');
                    document.getElementById('thumbnailImg').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleGalleryPreview(e) {
            const files = Array.from(e.target.files);
            const container = document.getElementById('galleryPreviewContainer');
            
            files.forEach((file, index) => {
                if (uploadedGalleryImages.length >= 5) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedGalleryImages.push({ file, dataUrl: event.target.result });
                    updateGalleryPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateGalleryPreview() {
            const container = document.getElementById('galleryPreviewContainer');
            container.innerHTML = uploadedGalleryImages.map((img, i) => `
                <div class="image-preview-item">
                    <img src="${img.dataUrl}" alt="Galerie ${i + 1}">
                    <div class="remove-btn" onclick="removeGalleryImage(${i})">
                        <i class="fas fa-times text-xs"></i>
                    </div>
                </div>
            `).join('');
        }

        function removeGalleryImage(index) {
            uploadedGalleryImages.splice(index, 1);
            updateGalleryPreview();
        }

        // ============ ADMIN TAB FUNCTIONS ============
        async function showAdminTab(tab) {
            const adminContent = document.getElementById('adminContent');
            if (!adminContent) return;

            adminContent.innerHTML = '<div class="flex justify-center py-8"><div class="spinner"></div></div>';

            const users = await DB.getUsers();
            const content = await DB.getContent();
            const settings = DB.getSettings();

            switch(tab) {
                case 'tokens':
                    adminContent.innerHTML = `
                        <div class="space-y-6">
                            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                                <h3 class="font-bold mb-4"><i class="fas fa-user text-yellow-400 mr-2"></i>Tokens an User senden</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Benutzer</label>
                                        <select id="tokenUserId" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                            ${users.filter(u => u.role !== 'admin').map(u => `<option value="${u.id}">${u.username} (${u.tokens} Tokens)</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Anzahl</label>
                                        <input type="number" id="tokenAmount" value="100" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Nachricht</label>
                                        <input type="text" id="tokenMessage" placeholder="z.B. Geschenk vom Admin" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button onclick="adminGiveTokens()" class="flex-1 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">
                                        <i class="fas fa-plus mr-2"></i>Tokens geben
                                    </button>
                                    <button onclick="adminTakeTokens()" class="flex-1 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold">
                                        <i class="fas fa-minus mr-2"></i>Tokens abziehen
                                    </button>
                                </div>
                            </div>

                            <div class="bg-yellow-500/10 rounded-xl p-6 border border-yellow-500/50">
                                <h3 class="font-bold mb-4 text-yellow-400"><i class="fas fa-users mr-2"></i>Tokens an ALLE User senden</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Anzahl pro User</label>
                                        <input type="number" id="tokenAmountAll" value="50" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Nachricht</label>
                                        <input type="text" id="tokenMessageAll" placeholder="z.B. Event-Belohnung!" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                </div>
                                <button onclick="adminGiveTokensToAll()" class="w-full mt-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold">
                                    <i class="fas fa-gift mr-2"></i>An alle ${users.filter(u => u.role !== 'admin').length} User senden
                                </button>
                            </div>
                        </div>
                    `;
                    break;

                case 'users':
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                            <div class="p-4 bg-gray-700/50 border-b border-gray-700">
                                <h3 class="font-bold"><i class="fas fa-users mr-2"></i>Benutzer (${users.length})</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="text-left p-4">Benutzer</th>
                                            <th class="text-left p-4">Rolle</th>
                                            <th class="text-left p-4">Tokens</th>
                                            <th class="text-left p-4">Auto-Approve</th>
                                            <th class="text-left p-4">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${users.map(u => `
                                            <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                                                <td class="p-4">
                                                    <div class="font-bold">${u.username || 'Unbekannt'}</div>
                                                    <div class="text-sm text-gray-400">${u.email}</div>
                                                </td>
                                                <td class="p-4">
                                                    <select onchange="adminSetUserRole('${u.id}', this.value)" class="px-3 py-1 bg-gray-600 rounded" ${u.email === ADMIN_EMAIL ? 'disabled' : ''}>
                                                        <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                                                        <option value="creator" ${u.role === 'creator' ? 'selected' : ''}>Creator</option>
                                                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                                    </select>
                                                </td>
                                                <td class="p-4 text-yellow-400 font-bold">${u.role === 'admin' ? '‚àû' : Utils.formatTokens(u.tokens)}</td>
                                                <td class="p-4">
                                                    ${u.role === 'creator' ? `
                                                        <label class="flex items-center cursor-pointer">
                                                            <input type="checkbox" ${u.auto_approve ? 'checked' : ''} onchange="adminToggleAutoApprove('${u.id}', this.checked)" class="w-5 h-5 accent-green-500">
                                                            <span class="ml-2 text-sm ${u.auto_approve ? 'text-green-400' : 'text-gray-400'}">${u.auto_approve ? 'Ja' : 'Nein'}</span>
                                                        </label>
                                                    ` : '<span class="text-gray-500">-</span>'}
                                                </td>
                                                <td class="p-4">
                                                    ${u.email !== ADMIN_EMAIL ? `
                                                        <button onclick="adminDeleteUser('${u.id}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    ` : '<span class="text-gray-500">-</span>'}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;

                case 'content':
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                            <div class="p-4 bg-gray-700/50 border-b border-gray-700">
                                <h3 class="font-bold"><i class="fas fa-box mr-2"></i>Inhalte (${content.length})</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th class="text-left p-4">Titel</th>
                                            <th class="text-left p-4">Uploader</th>
                                            <th class="text-left p-4">Status</th>
                                            <th class="text-left p-4">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${content.map(c => `
                                            <tr class="border-t border-gray-700 hover:bg-gray-700/50 ${!c.approved ? 'bg-yellow-500/10' : ''}">
                                                <td class="p-4">
                                                    <div class="font-bold">${c.title}</div>
                                                    <div class="text-sm text-gray-400">${c.price} Tokens</div>
                                                </td>
                                                <td class="p-4 text-gray-400">${c.uploaderName || 'Unbekannt'}</td>
                                                <td class="p-4">
                                                    <span class="px-2 py-1 rounded text-xs ${c.approved ? 'bg-green-600' : 'bg-yellow-600'}">
                                                        ${c.approved ? 'Genehmigt' : 'Ausstehend'}
                                                    </span>
                                                </td>
                                                <td class="p-4">
                                                    <div class="flex gap-2">
                                                        <button onclick="viewContent('${c.id}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded"><i class="fas fa-eye"></i></button>
                                                        ${!c.approved ? `<button onclick="adminApproveContent('${c.id}')" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded"><i class="fas fa-check"></i></button>` : ''}
                                                        <button onclick="adminDeleteContent('${c.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded"><i class="fas fa-trash"></i></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;

                case 'settings':
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700 space-y-6">
                            <h3 class="font-bold"><i class="fas fa-cog mr-2"></i>Globale Einstellungen</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <label class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-upload mr-2 text-green-400"></i>Uploads aktiv</span>
                                    <input type="checkbox" id="settingUploads" ${settings.uploadsEnabled ? 'checked' : ''} onchange="updateAdminSetting('uploadsEnabled', this.checked)" class="w-5 h-5 accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-shopping-cart mr-2 text-blue-400"></i>Verk√§ufe aktiv</span>
                                    <input type="checkbox" id="settingSales" ${settings.salesEnabled ? 'checked' : ''} onchange="updateAdminSetting('salesEnabled', this.checked)" class="w-5 h-5 accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-coins mr-2 text-yellow-400"></i>Token-System</span>
                                    <input type="checkbox" id="settingTokens" ${settings.tokenSystemEnabled ? 'checked' : ''} onchange="updateAdminSetting('tokenSystemEnabled', this.checked)" class="w-5 h-5 accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-user-plus mr-2 text-cyan-400"></i>Registrierung</span>
                                    <input type="checkbox" id="settingReg" ${settings.registrationEnabled ? 'checked' : ''} onchange="updateAdminSetting('registrationEnabled', this.checked)" class="w-5 h-5 accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-gray-700/50 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-check mr-2 text-purple-400"></i>Genehmigung n√∂tig</span>
                                    <input type="checkbox" id="settingApproval" ${settings.requireApproval ? 'checked' : ''} onchange="updateAdminSetting('requireApproval', this.checked)" class="w-5 h-5 accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-red-500/20 border border-red-500 rounded-lg cursor-pointer">
                                    <span><i class="fas fa-tools mr-2 text-red-400"></i>Wartungsmodus</span>
                                    <input type="checkbox" id="settingMaintenance" ${settings.maintenanceMode ? 'checked' : ''} onchange="updateAdminSetting('maintenanceMode', this.checked)" class="w-5 h-5 accent-red-500">
                                </label>
                            </div>

                            <div class="border-t border-gray-700 pt-6">
                                <h4 class="font-bold mb-4"><i class="fas fa-coins mr-2 text-yellow-400"></i>Token-Einstellungen</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Intervall</label>
                                        <select id="settingInterval" onchange="updateAdminSetting('tokenInterval', this.value)" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                            <option value="hourly" ${settings.tokenInterval === 'hourly' ? 'selected' : ''}>St√ºndlich</option>
                                            <option value="daily" ${settings.tokenInterval === 'daily' ? 'selected' : ''}>T√§glich</option>
                                            <option value="weekly" ${settings.tokenInterval === 'weekly' ? 'selected' : ''}>W√∂chentlich</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Tokens pro Intervall</label>
                                        <input type="number" id="settingAmount" value="${settings.tokenAmount}" onchange="updateAdminSetting('tokenAmount', parseInt(this.value))" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Willkommens-Tokens</label>
                                        <input type="number" id="settingWelcome" value="${settings.welcomeTokens}" onchange="updateAdminSetting('welcomeTokens', parseInt(this.value))" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'logs':
                    const logs = await DB.getAdminLogs();
                    adminContent.innerHTML = `
                        <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-bold mb-4"><i class="fas fa-history mr-2"></i>Admin-Logs</h3>
                            ${logs.length === 0 ? '<p class="text-gray-400">Keine Logs vorhanden</p>' : `
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${logs.map(l => `
                                        <div class="p-3 bg-gray-700/50 rounded-lg text-sm">
                                            <div class="flex justify-between">
                                                <span class="font-bold text-blue-400">${l.action}</span>
                                                <span class="text-gray-500">${Utils.formatDate(l.created_at)}</span>
                                            </div>
                                            <div class="text-gray-400">${l.target_type}: ${l.target_id || 'N/A'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    `;
                    break;
            }
        }

        // ============ HELPER FUNCTIONS ============
        function toggleProfileDropdown() {
            const menu = document.getElementById('profileMenu');
            if (menu) menu.classList.toggle('hidden');
        }

        function closeProfileDropdown() {
            const menu = document.getElementById('profileMenu');
            if (menu) menu.classList.add('hidden');
        }

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown && !dropdown.contains(e.target)) closeProfileDropdown();
        });

        function showModal(content) {
            const existing = document.getElementById('modal-overlay');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'modal-overlay';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in';
            modal.innerHTML = `<div class="bg-gray-800 rounded-xl border border-gray-700 p-6 max-w-lg w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">${content}</div>`;
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            if (modal) modal.remove();
        }

        async function claimNotification(notifId) {
            await getSupabase().from('notifications').update({ is_read: true, is_claimed: true }).eq('id', notifId);
            notifications = notifications.filter(n => n.id !== notifId);
            closeModal();
            Render.app();
        }

        async function showNotificationsModal() {
            await DB.loadNotifications();
            showModal(`
                <h2 class="text-xl font-bold mb-4"><i class="fas fa-bell mr-2 text-yellow-400"></i>Benachrichtigungen</h2>
                ${notifications.length === 0 ? '<p class="text-gray-400">Keine Benachrichtigungen</p>' : `
                    <div class="space-y-3 max-h-80 overflow-y-auto">
                        ${notifications.map(n => `
                            <div class="p-4 bg-gray-700/50 rounded-lg">
                                <div class="font-bold">${n.title}</div>
                                <div class="text-gray-400 text-sm">${n.message}</div>
                                ${n.token_amount ? `<div class="text-yellow-400 font-bold mt-2">${n.token_amount > 0 ? '+' : ''}${n.token_amount} Tokens</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `}
                <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg">Schlie√üen</button>
            `);
        }

        async function showEditContentModal(contentId) {
            const allContent = await DB.getContent();
            const item = allContent.find(c => c.id === contentId);
            if (!item) return;

            showModal(`
                <h2 class="text-xl font-bold mb-4"><i class="fas fa-edit mr-2 text-yellow-400"></i>Inhalt bearbeiten</h2>
                <form onsubmit="handleEditContent(event, '${contentId}')">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Titel</label>
                            <input type="text" id="editTitle" value="${item.title}" required class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Beschreibung</label>
                            <textarea id="editDesc" rows="4" class="w-full px-4 py-3 bg-gray-700 rounded-lg">${item.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Kategorie</label>
                                <select id="editCategory" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                                    <option value="plugin" ${item.category === 'plugin' ? 'selected' : ''}>Plugin</option>
                                    <option value="mod" ${item.category === 'mod' ? 'selected' : ''}>Mod</option>
                                    <option value="texturepack" ${item.category === 'texturepack' ? 'selected' : ''}>Texturepack</option>
                                    <option value="world" ${item.category === 'world' ? 'selected' : ''}>Welt</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Preis</label>
                                <input type="number" id="editPrice" value="${item.price}" min="0" class="w-full px-4 py-3 bg-gray-700 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-gray-600 rounded-lg font-bold">Abbrechen</button>
                        <button type="submit" class="flex-1 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">Speichern</button>
                    </div>
                </form>
            `);
        }

        async function handleEditContent(e, contentId) {
            e.preventDefault();
            
            await getSupabase().from('content').update({
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDesc').value,
                category: document.getElementById('editCategory').value,
                price: parseInt(document.getElementById('editPrice').value) || 0
            }).eq('id', contentId);

            closeModal();
            Utils.showToast('Inhalt aktualisiert!');
            await Render.navigate('content-detail');
        }

        // ============ DSGVO DATA EXPORT ============
        async function exportUserData() {
            const user = DB.getCurrentUser();
            if (!user) return;

            Utils.showToast('Daten werden gesammelt...', 'info');

            const purchases = await DB.getPurchases();
            const transactions = await DB.getTransactions();
            const content = await DB.getContent();
            const myContent = content.filter(c => c.uploaderId === user.id);

            const exportData = {
                _info: {
                    exportDate: new Date().toISOString(),
                    exportType: 'DSGVO Art. 15 & 20 - Vollst√§ndige Datenauskunft',
                    platform: 'MCMarket'
                },
                personalData: {
                    id: user.id,
                    username: user.username,
                    email: user.email,
                    role: user.role,
                    tokens: user.tokens,
                    created_at: user.created_at,
                    last_token_claim: user.last_token_claim
                },
                purchases: purchases,
                transactions: transactions,
                uploadedContent: myContent.map(c => ({
                    id: c.id,
                    title: c.title,
                    category: c.category,
                    price: c.price,
                    downloads: c.downloads,
                    created_at: c.createdAt
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mcmarket-daten-${user.username}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Utils.showToast('Daten heruntergeladen!');
        }

        // ============ EVENT HANDLERS ============
        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('bg-green-600', tab === 'login');
            document.getElementById('registerTab').classList.toggle('bg-green-600', tab === 'register');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            Utils.showToast('Anmelden...', 'info');
            
            const user = await Auth.login(email, password);
            if (user) {
                Utils.showToast(`Willkommen, ${user.username || 'User'}!`);
                currentView = 'marketplace';
                Render.app();
            } else {
                Utils.showToast('Ung√ºltige Anmeldedaten', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value;
            
            if (!document.getElementById('agbCheckbox').checked) {
                Utils.showToast('Bitte AGB akzeptieren', 'error');
                return;
            }
            
            Utils.showToast('Registrieren...', 'info');
            
            const result = await Auth.register(username, email, password);
            if (result.success) {
                Utils.showToast('Willkommen!');
                currentView = 'marketplace';
                Render.app();
            } else {
                Utils.showToast(result.error || 'Registrierung fehlgeschlagen', 'error');
            }
        }

        async function handleLogout() {
            await Auth.logout();
            currentView = 'login';
            Render.app();
            Utils.showToast('Abgemeldet', 'info');
        }

        async function handleClaimTokens() {
            const success = await Auth.claimTokens();
            if (success) {
                Utils.showToast(`+${DB.getSettings().tokenAmount} Tokens!`);
                Render.app();
            } else {
                Utils.showToast('Tokens noch nicht verf√ºgbar', 'error');
            }
        }

        function updateFilter(key, value) {
            filterState[key] = value;
            Render.marketplace();
        }

        function viewContent(id) {
            selectedContent = id;
            Render.navigate('content-detail');
        }

        async function handlePurchase(id) {
            const result = await Content.purchase(id);
            if (result === true) {
                Utils.showToast('Erfolgreich gekauft!');
                Render.app();
                await Render.navigate('content-detail');
            } else if (result === 'already') {
                Utils.showToast('Bereits gekauft', 'info');
            } else {
                Utils.showToast('Kauf fehlgeschlagen', 'error');
            }
        }

        async function handleDownload(id) {
            const allContent = await DB.getContent();
            const item = allContent.find(c => c.id === id);
            
            if (!item) {
                Utils.showToast('Inhalt nicht gefunden', 'error');
                return;
            }

            if (!item.fileUrl) {
                Utils.showToast('Keine Datei vorhanden', 'error');
                return;
            }

            await getSupabase().from('content').update({ 
                downloads: (item.downloads || 0) + 1 
            }).eq('id', id);

            const a = document.createElement('a');
            a.href = item.fileUrl;
            a.download = item.fileName || 'download';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            Utils.showToast('Download gestartet!');
        }

        async function handleUpload(e) {
            e.preventDefault();
            
            const title = document.getElementById('uploadTitle').value.trim();
            const description = document.getElementById('uploadDesc').value.trim();
            const category = document.getElementById('uploadCategory').value;
            const version = document.getElementById('uploadVersion').value.trim() || '1.0';
            const price = parseInt(document.getElementById('uploadPrice').value) || 0;
            const mcVersions = Array.from(document.querySelectorAll('input[name="mcVersion"]:checked')).map(c => c.value);
            const file = document.getElementById('fileInput').files[0];
            const thumbnailFile = document.getElementById('thumbnailInput').files[0];

            if (!file) {
                Utils.showToast('Bitte Datei ausw√§hlen', 'error');
                return;
            }

            if (!thumbnailFile) {
                Utils.showToast('Bitte Vorschaubild ausw√§hlen', 'error');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                Utils.showToast('Datei zu gro√ü (max 50MB)', 'error');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Wird hochgeladen...';

            try {
                const user = DB.getCurrentUser();
                const settings = DB.getSettings();
                const contentId = Utils.generateId();

                // Datei hochladen
                Utils.showToast('Lade Datei hoch...', 'info');
                const fileUrl = await DB.uploadFile(file, contentId);
                
                if (!fileUrl) {
                    Utils.showToast('Datei-Upload fehlgeschlagen', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-upload mr-2"></i>Hochladen';
                    return;
                }

                // Thumbnail hochladen
                Utils.showToast('Lade Vorschaubild hoch...', 'info');
                const imageUrl = await DB.uploadImage(thumbnailFile, contentId, '_thumb');

                // Galerie-Bilder hochladen
                const galleryUrls = [];
                for (let i = 0; i < uploadedGalleryImages.length; i++) {
                    Utils.showToast(`Lade Galerie-Bild ${i + 1}/${uploadedGalleryImages.length}...`, 'info');
                    const url = await DB.uploadImage(uploadedGalleryImages[i].file, contentId, `_gallery_${i}`);
                    if (url) galleryUrls.push(url);
                }

                // Pr√ºfen ob User auto_approve hat
                const userHasAutoApprove = user.auto_approve === true;
                const shouldApprove = DB.isAdmin(user) || userHasAutoApprove || !settings.requireApproval;

                // Content in Datenbank speichern
                const { error } = await getSupabase().from('content').insert({
                    id: contentId,
                    title,
                    description,
                    category,
                    version,
                    price,
                    mc_versions: mcVersions,
                    visibility: 'public',
                    file_name: file.name,
                    file_size: Utils.formatFileSize(file.size),
                    file_url: fileUrl,
                    image_url: imageUrl,
                    gallery_urls: galleryUrls,
                    uploader_id: user.id,
                    uploader_name: user.username || 'Unbekannt',
                    downloads: 0,
                    approved: shouldApprove
                });

                if (error) {
                    Utils.showToast('Fehler beim Speichern: ' + error.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-upload mr-2"></i>Hochladen';
                    return;
                }

                uploadedGalleryImages = [];
                Utils.showToast(DB.isAdmin(user) ? 'Ver√∂ffentlicht!' : 'Hochgeladen - wartet auf Genehmigung');
                await Render.navigate('marketplace');
            } catch (err) {
                console.error('Upload error:', err);
                Utils.showToast('Upload fehlgeschlagen', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-2"></i>Hochladen';
            }
        }

        // ============ ADMIN FUNCTIONS ============
        async function adminGiveTokens() {
            const userId = document.getElementById('tokenUserId').value;
            const amount = parseInt(document.getElementById('tokenAmount').value) || 0;
            const message = document.getElementById('tokenMessage').value;
            
            if (await Admin.giveTokensToUser(userId, amount, message)) {
                Utils.showToast(`+${amount} Tokens vergeben!`);
                showAdminTab('tokens');
            }
        }

        async function adminTakeTokens() {
            const userId = document.getElementById('tokenUserId').value;
            const amount = parseInt(document.getElementById('tokenAmount').value) || 0;
            const message = document.getElementById('tokenMessage').value;
            
            if (await Admin.giveTokensToUser(userId, -amount, message || 'Tokens abgezogen')) {
                Utils.showToast(`-${amount} Tokens abgezogen!`);
                showAdminTab('tokens');
            }
        }

        async function adminGiveTokensToAll() {
            const amount = parseInt(document.getElementById('tokenAmountAll').value) || 0;
            const message = document.getElementById('tokenMessageAll').value;
            
            if (confirm(`Wirklich ${amount} Tokens an ALLE User senden?`)) {
                Utils.showToast('Tokens werden verteilt...', 'info');
                if (await Admin.giveTokensToAll(amount, message)) {
                    Utils.showToast('Tokens an alle verteilt!');
                    showAdminTab('tokens');
                }
            }
        }

        async function adminSetUserRole(userId, role) {
            if (await Admin.setUserRole(userId, role)) {
                Utils.showToast('Rolle ge√§ndert');
                showAdminTab('users');
            }
        }

        async function adminToggleAutoApprove(userId, enabled) {
            const user = DB.getCurrentUser();
            if (!DB.isAdmin(user)) return;
            
            await getSupabase().from('profiles').update({ auto_approve: enabled }).eq('id', userId);
            await DB.addAdminLog('toggle_auto_approve', 'user', userId, { enabled });
            Utils.showToast(enabled ? 'Auto-Genehmigung aktiviert' : 'Auto-Genehmigung deaktiviert');
        }

        async function adminDeleteUser(userId) {
            if (confirm('User wirklich l√∂schen?')) {
                if (await Admin.deleteUser(userId)) {
                    Utils.showToast('User gel√∂scht');
                    showAdminTab('users');
                }
            }
        }

        async function adminApproveContent(contentId) {
            if (await Admin.approveContent(contentId)) {
                Utils.showToast('Genehmigt');
                showAdminTab('content');
            }
        }

        async function adminDeleteContent(contentId) {
            if (confirm('Inhalt wirklich l√∂schen?')) {
                if (await Admin.deleteContent(contentId)) {
                    Utils.showToast('Gel√∂scht');
                    await Render.navigate('marketplace');
                }
            }
        }

        async function updateAdminSetting(key, value) {
            const settings = DB.getSettings();
            settings[key] = value;
            if (await Admin.updateSettings(settings)) {
                Utils.showToast('Einstellung gespeichert');
            }
        }

        // ============ LEGAL PAGES ============
        const Legal = {
            showImpressum() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-gavel mr-2 text-blue-400"></i>Impressum</h2>
                    <div class="text-sm text-gray-300 space-y-2">
                        <p><strong>MCMarket</strong></p>
                        <p>Kontakt: mcmarket.2026@gmail.com</p>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg">Schlie√üen</button>
                `);
            },

            showDatenschutz() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-shield-alt mr-2 text-green-400"></i>Datenschutz</h2>
                    <div class="text-sm text-gray-300 space-y-2 max-h-80 overflow-y-auto">
                        <p><strong>Gespeicherte Daten:</strong></p>
                        <ul class="list-disc list-inside">
                            <li>E-Mail-Adresse</li>
                            <li>Benutzername</li>
                            <li>Token-Guthaben</li>
                            <li>Kaufhistorie</li>
                            <li>Hochgeladene Inhalte</li>
                        </ul>
                        <p class="mt-4"><strong>Deine Rechte (DSGVO):</strong></p>
                        <ul class="list-disc list-inside">
                            <li>Auskunft √ºber gespeicherte Daten</li>
                            <li>Datenexport (im Profil)</li>
                            <li>L√∂schung deines Accounts</li>
                        </ul>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg">Schlie√üen</button>
                `);
            },

            showAGB() {
                showModal(`
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-file-contract mr-2 text-yellow-400"></i>AGB</h2>
                    <div class="text-sm text-gray-300 space-y-2 max-h-80 overflow-y-auto">
                        <p><strong>1. Token-System</strong></p>
                        <ul class="list-disc list-inside">
                            <li>Tokens haben keinen Echtgeldwert</li>
                            <li>Tokens k√∂nnen nicht ausgezahlt werden</li>
                        </ul>
                        <p class="mt-2"><strong>2. Inhalte</strong></p>
                        <ul class="list-disc list-inside">
                            <li>Keine illegalen Inhalte</li>
                            <li>Uploader sind verantwortlich</li>
                        </ul>
                        <p class="mt-2"><strong>3. K√§ufe</strong></p>
                        <ul class="list-disc list-inside">
                            <li>K√§ufe sind endg√ºltig</li>
                            <li>Keine Erstattung</li>
                        </ul>
                    </div>
                    <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg">Schlie√üen</button>
                `);
            }
        };

        // ============ INIT ============
        async function initApp() {
            setLoadingStatus('Initialisiere...');
            
            try {
                await DB.init();
                Render.app();
            } catch (e) {
                console.error('Init Fehler:', e);
                showError(e.message || 'Unbekannter Fehler');
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
